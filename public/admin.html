<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×‘×¨×›×ª ×”×©×“×” - ×¤×× ×œ × ×™×”×•×œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/shared.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans Hebrew', sans-serif; }
    body { direction: rtl; background: #f3f4f6; }
    .sidebar-link { transition: all 0.2s; }
    .sidebar-link:hover, .sidebar-link.active { background: rgba(255,255,255,0.15); }
    .stat-card { transition: all 0.3s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; white-space: nowrap; }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #4a7c23; box-shadow: 0 0 0 3px rgba(74,124,35,0.1); }
    .toggle-switch { position: relative; width: 56px; height: 28px; background: #d1d5db; border-radius: 14px; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
    .toggle-switch.active { background: #4a7c23; }
    .toggle-switch::after { content: ''; position: absolute; top: 2px; right: 2px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle-switch.active::after { right: 30px; }
    .order-row:hover { background: #f9fafb; }
    .price-input { width: 100px; }
    /* Mobile sidebar overlay */
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
    .sidebar-overlay.active { display: block; }
    /* Notification toast */
    .notification-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; animation: slideDown 0.4s ease, fadeOut 0.4s ease 5.6s forwards; max-width: 90vw; }
    @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    /* Mobile top bar */
    .mobile-topbar { display: none; }
    @media (max-width: 768px) {
      .mobile-topbar { display: flex; position: fixed; top: 0; right: 0; left: 0; height: 56px; background: #276749; color: white; align-items: center; padding: 0 16px; z-index: 30; gap: 12px; }
      .desktop-sidebar { transform: translateX(100%); transition: transform 0.3s ease; z-index: 50; }
      .desktop-sidebar.open { transform: translateX(0); }
      .main-content { margin-right: 0 !important; padding-top: 72px !important; }
    }
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

// Shared globals from js/shared.js: supabaseClient, SUPABASE_URL, SUPABASE_KEY, PRODUCT_IMAGES, getProductImage, CATEGORIES, CATEGORY_MAP
const sb = supabaseClient;

// ==================== MOCK DATA (fallback) ====================
const INITIAL_PRODUCTS = [
  { id: 1, name: '×ª×¤×•×—×™× ×—×¨××•×Ÿ', category: 'fruits', unit: 'kg', price: 12.90, active: true, image: 'ğŸ' },
  { id: 2, name: '×‘× × ×•×ª', category: 'fruits', unit: 'kg', price: 9.90, active: true, image: 'ğŸŒ' },
  { id: 3, name: '×¢× ×‘×™× ×™×¨×•×§×™×', category: 'fruits', unit: 'kg', price: 19.90, active: true, image: 'ğŸ‡' },
  { id: 4, name: '××‘×˜×™×—', category: 'fruits', unit: 'kg', price: 4.90, active: true, image: 'ğŸ‰' },
  { id: 5, name: '××’×¡×™×', category: 'fruits', unit: 'kg', price: 14.90, active: true, image: 'ğŸ' },
  { id: 6, name: '× ×§×˜×¨×™× ×•×ª', category: 'fruits', unit: 'kg', price: 15.90, active: true, image: 'ğŸ‘' },
  { id: 7, name: '×ª×•×ª×™×', category: 'fruits', unit: 'unit', price: 14.90, active: true, image: 'ğŸ“' },
  { id: 8, name: '×¨×™××•× ×™×', category: 'fruits', unit: 'kg', price: 12.90, active: true, image: 'ğŸ' },
  { id: 11, name: '×¢×’×‘× ×™×•×ª', category: 'vegetables', unit: 'kg', price: 6.90, active: true, image: 'ğŸ…' },
  { id: 12, name: '××œ×¤×¤×•× ×™×', category: 'vegetables', unit: 'kg', price: 5.90, active: true, image: 'ğŸ¥’' },
  { id: 13, name: '×¤×œ×¤×œ ××“×•×', category: 'vegetables', unit: 'kg', price: 11.90, active: true, image: 'ğŸ«‘' },
  { id: 14, name: '×¤×œ×¤×œ ×™×¨×•×§', category: 'vegetables', unit: 'kg', price: 7.90, active: true, image: 'ğŸ«‘' },
  { id: 15, name: '×—×¡×”', category: 'vegetables', unit: 'unit', price: 5.90, active: true, image: 'ğŸ¥¬' },
  { id: 16, name: '×’×–×¨', category: 'vegetables', unit: 'kg', price: 4.90, active: true, image: 'ğŸ¥•' },
  { id: 17, name: '×‘×¦×œ ×™×‘×©', category: 'vegetables', unit: 'kg', price: 4.90, active: true, image: 'ğŸ§…' },
  { id: 18, name: '×ª×¤×•×— ××“××”', category: 'vegetables', unit: 'kg', price: 5.90, active: true, image: 'ğŸ¥”' },
  { id: 19, name: '×—×¦×™×œ', category: 'vegetables', unit: 'kg', price: 7.90, active: true, image: 'ğŸ†' },
  { id: 20, name: '×§×™×©×•×', category: 'vegetables', unit: 'kg', price: 6.90, active: true, image: 'ğŸ¥’' },
  { id: 26, name: '×¤×˜×¨×•×–×™×œ×™×”', category: 'herbs', unit: 'unit', price: 3.90, active: true, image: 'ğŸŒ¿' },
  { id: 27, name: '×›×•×¡×‘×¨×”', category: 'herbs', unit: 'unit', price: 3.90, active: true, image: 'ğŸŒ¿' },
  { id: 28, name: '× ×¢× ×¢', category: 'herbs', unit: 'unit', price: 3.90, active: true, image: 'ğŸŒ¿' },
  { id: 32, name: '×ª×¤×•×–×™×', category: 'fruits', unit: 'kg', price: 6.90, active: true, image: 'ğŸŠ' },
  { id: 33, name: '×œ×™××•×Ÿ', category: 'fruits', unit: 'kg', price: 7.90, active: true, image: 'ğŸ‹' },
  { id: 37, name: '×× ×’×•', category: 'exotic', unit: 'kg', price: 24.90, active: true, image: 'ğŸ¥­' },
  { id: 38, name: '××‘×•×§×“×•', category: 'exotic', unit: 'kg', price: 19.90, active: true, image: 'ğŸ¥‘' },
];

const INITIAL_ORDERS = [
  {
    id: 1001, orderNumber: 4521, customerName: '×™×•×¡×™ ×›×”×Ÿ', phone: '050-1234567', email: 'yossi@email.com',
    deliveryType: 'delivery', address: '×¨×—×•×‘ ×”×“×§×œ 5, ×‘×™×ª ×©××©',
    items: [
      { name: '×¢×’×‘× ×™×•×ª', qty: 2, unit: 'kg', price: 6.90 },
      { name: '××œ×¤×¤×•× ×™×', qty: 1.5, unit: 'kg', price: 5.90 },
      { name: '×¤×œ×¤×œ ××“×•×', qty: 1, unit: 'kg', price: 11.90 },
      { name: '×‘× × ×•×ª', qty: 1, unit: 'kg', price: 9.90 },
    ],
    total: 44.55, status: 'pending', paymentStatus: 'paid', notes: '', timeSlot: '10:00-12:00', createdAt: new Date(Date.now() - 1000*60*15),
  },
  {
    id: 1002, orderNumber: 4522, customerName: '×©×¨×” ×œ×•×™', phone: '052-9876543', email: '',
    deliveryType: 'pickup', address: '',
    items: [
      { name: '×ª×¤×•×—×™× ×—×¨××•×Ÿ', qty: 3, unit: 'kg', price: 12.90 },
      { name: '×‘× × ×•×ª', qty: 2, unit: 'kg', price: 9.90 },
      { name: '×—×¡×”', qty: 2, unit: 'unit', price: 5.90 },
      { name: '×¤×˜×¨×•×–×™×œ×™×”', qty: 1, unit: 'unit', price: 3.90 },
      { name: '× ×¢× ×¢', qty: 1, unit: 'unit', price: 3.90 },
    ],
    total: 77.30, status: 'confirmed', paymentStatus: 'paid', notes: '×× ×™ ×¦×¨×™×›×” ××ª ×–×” ×¢×“ 14:00', timeSlot: '12:00-14:00', createdAt: new Date(Date.now() - 1000*60*45),
  },
  {
    id: 1003, orderNumber: 4523, customerName: '×“×•×“ ×™×©×¨××œ×™', phone: '054-5555555', email: 'david@mail.com',
    deliveryType: 'delivery', address: '×¨×—×•×‘ ×”×¨×¦×œ 28, ×‘×™×ª ×©××©',
    items: [
      { name: '×× ×’×•', qty: 2, unit: 'kg', price: 24.90 },
      { name: '××‘×•×§×“×•', qty: 1.5, unit: 'kg', price: 19.90 },
      { name: '×œ×™××•×Ÿ', qty: 1, unit: 'kg', price: 7.90 },
    ],
    total: 87.55, status: 'ready', paymentStatus: 'paid', notes: '', timeSlot: '16:00-18:00', createdAt: new Date(Date.now() - 1000*60*120),
  },
  {
    id: 1004, orderNumber: 4524, customerName: '×¨×—×œ ××–×¨×—×™', phone: '058-7777777', email: '',
    deliveryType: 'pickup', address: '',
    items: [
      { name: '×¢×’×‘× ×™×•×ª', qty: 3, unit: 'kg', price: 6.90 },
      { name: '××œ×¤×¤×•× ×™×', qty: 2, unit: 'kg', price: 5.90 },
      { name: '×’×–×¨', qty: 1, unit: 'kg', price: 4.90 },
      { name: '×‘×¦×œ ×™×‘×©', qty: 2, unit: 'kg', price: 4.90 },
      { name: '×ª×¤×•×— ××“××”', qty: 3, unit: 'kg', price: 5.90 },
    ],
    total: 68.20, status: 'completed', paymentStatus: 'paid', notes: '', timeSlot: '08:00-10:00', createdAt: new Date(Date.now() - 1000*60*240),
  },
  {
    id: 1005, orderNumber: 4525, customerName: '××‘×¨×”× ×’×•×œ×“', phone: '053-1111111', email: 'avi@test.com',
    deliveryType: 'delivery', address: '×©×“\' ×‘×Ÿ ×’×•×¨×™×•×Ÿ 14, ×‘×™×ª ×©××©',
    items: [
      { name: '×ª×¤×•×–×™×', qty: 5, unit: 'kg', price: 6.90 },
      { name: '×ª×¤×•×—×™× ×—×¨××•×Ÿ', qty: 2, unit: 'kg', price: 12.90 },
      { name: '×¢× ×‘×™× ×™×¨×•×§×™×', qty: 1, unit: 'kg', price: 19.90 },
    ],
    total: 80.20, status: 'pending', paymentStatus: 'paid', notes: '×‘×‘×§×©×” ×œ×”×ª×§×©×¨ ×œ×¤× ×™', timeSlot: '14:00-16:00', createdAt: new Date(Date.now() - 1000*60*5),
  },
];

const STATUS_MAP = {
  pending: { label: '×××ª×™×Ÿ', color: 'bg-yellow-100 text-yellow-800', icon: 'â³' },
  confirmed: { label: '××•×©×¨', color: 'bg-blue-100 text-blue-800', icon: 'âœ“' },
  ready: { label: '××•×›×Ÿ', color: 'bg-purple-100 text-purple-800', icon: 'ğŸ“¦' },
  completed: { label: '×”×•×©×œ×', color: 'bg-green-100 text-green-800', icon: 'âœ…' },
  cancelled: { label: '×‘×•×˜×œ', color: 'bg-red-100 text-red-800', icon: 'âŒ' },
};

// CATEGORY_MAP loaded from js/shared.js

// ==================== LOGIN ====================
function LoginPage({ onLogin }) {
  const [email, setEmail] = useState('admin@birkat.co.il');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleLogin = (e) => {
    e.preventDefault();
    if (!email || !password) {
      setError('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
    } else if (password !== 'yoni123') {
      setError('×¡×™×¡××” ×©×’×•×™×”');
    } else {
      onLogin({ email, name: '×× ×”×œ ×¨××©×™' });
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-green-800 to-green-900 p-4">
      <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
        <div className="text-center mb-8">
          <div className="w-16 h-16 bg-green-700 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-3">×‘</div>
          <h1 className="text-2xl font-bold text-gray-800">×‘×¨×›×ª ×”×©×“×”</h1>
          <p className="text-gray-500">×¤×× ×œ × ×™×”×•×œ</p>
        </div>
        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">××™××™×™×œ</label>
            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-200" dir="ltr" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">×¡×™×¡××”</label>
            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-200" placeholder="×”×›× ×¡ ×¡×™×¡××”" />
          </div>
          {error && <p className="text-red-500 text-sm">{error}</p>}
          <button type="submit" className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">
            ×”×ª×—×‘×¨
          </button>
        </form>
        <p className="text-xs text-gray-400 text-center mt-4">×¤×× ×œ × ×™×”×•×œ - ×”×›× ×¡ ×¡×™×¡××” ×œ×›× ×™×¡×”</p>
      </div>
    </div>
  );
}

// ==================== SIDEBAR ====================
function Sidebar({ activePage, setPage, user, onLogout, isOpen, onClose }) {
  const links = [
    { id: 'dashboard', label: '×“×©×‘×•×¨×“', icon: 'ğŸ“Š' },
    { id: 'orders', label: '×”×–×× ×•×ª', icon: 'ğŸ“‹' },
    { id: 'pricing', label: '××—×™×¨×™×', icon: 'ğŸ’°' },
    { id: 'products', label: '××•×¦×¨×™×', icon: 'ğŸ“¦' },
    { id: 'settings', label: '×”×’×“×¨×•×ª', icon: 'âš™ï¸' },
  ];

  const handlePageClick = (id) => {
    setPage(id);
    if (onClose) onClose();
  };

  return (
    <>
      <div className={`sidebar-overlay ${isOpen ? 'active' : ''}`} onClick={onClose}></div>
      <aside className={`desktop-sidebar w-64 bg-green-800 text-white min-h-screen fixed right-0 top-0 flex flex-col ${isOpen ? 'open' : ''}`}>
        <div className="p-6 border-b border-green-700">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center font-bold">×‘</div>
            <div>
              <h2 className="font-bold">×‘×¨×›×ª ×”×©×“×”</h2>
              <p className="text-xs text-green-300">×¤×× ×œ × ×™×”×•×œ</p>
            </div>
          </div>
        </div>

        <nav className="flex-1 py-4">
          {links.map(link => (
            <button
              key={link.id}
              onClick={() => handlePageClick(link.id)}
              className={`sidebar-link w-full text-right px-6 py-3 flex items-center gap-3 ${activePage === link.id ? 'active bg-green-700' : ''}`}
            >
              <span>{link.icon}</span>
              <span className="font-medium">{link.label}</span>
            </button>
          ))}
        </nav>

        <div className="p-4 border-t border-green-700">
          <div className="text-sm mb-2">ğŸ‘¤ {user.name}</div>
          <div className="flex gap-2">
            <a href="index.html" className="text-xs text-green-300 hover:text-white">×¦×¤×” ×‘××ª×¨ â†’</a>
            <button onClick={onLogout} className="text-xs text-red-300 hover:text-red-100 mr-auto">×”×ª× ×ª×§</button>
          </div>
        </div>
      </aside>
    </>
  );
}

// ==================== DASHBOARD ====================
function DashboardPage({ orders, settings }) {
  const today = new Date().toLocaleDateString('he-IL');
  const todayOrders = orders.filter(o => o.status !== 'cancelled');
  const pendingOrders = orders.filter(o => o.status === 'pending');
  const totalRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
  const completedOrders = orders.filter(o => o.status === 'completed');

  return (
    <div className="fade-in">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-2">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">×“×©×‘×•×¨×“</h1>
          <p className="text-gray-500 text-sm">{today}</p>
        </div>
        <div className={`px-4 py-2 rounded-full text-sm font-bold ${settings.orderingOpen ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
          {settings.orderingOpen ? 'âœ… ×”×–×× ×•×ª ×¤×ª×•×—×•×ª' : 'âŒ ×”×–×× ×•×ª ×¡×’×•×¨×•×ª'}
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div className="stat-card bg-white rounded-xl p-5 shadow-sm">
          <div className="text-3xl mb-1">ğŸ“‹</div>
          <div className="text-3xl font-bold text-gray-800">{todayOrders.length}</div>
          <div className="text-sm text-gray-500">×”×–×× ×•×ª ×”×™×•×</div>
        </div>
        <div className="stat-card bg-white rounded-xl p-5 shadow-sm">
          <div className="text-3xl mb-1">â³</div>
          <div className="text-3xl font-bold text-yellow-600">{pendingOrders.length}</div>
          <div className="text-sm text-gray-500">×××ª×™× ×•×ª ×œ××™×©×•×¨</div>
        </div>
        <div className="stat-card bg-white rounded-xl p-5 shadow-sm">
          <div className="text-3xl mb-1">ğŸ’°</div>
          <div className="text-3xl font-bold text-green-700">{totalRevenue.toFixed(0)}â‚ª</div>
          <div className="text-sm text-gray-500">×”×›× ×¡×•×ª ×”×™×•×</div>
        </div>
        <div className="stat-card bg-white rounded-xl p-5 shadow-sm">
          <div className="text-3xl mb-1">âœ…</div>
          <div className="text-3xl font-bold text-blue-600">{completedOrders.length}</div>
          <div className="text-sm text-gray-500">×”×–×× ×•×ª ×©×”×•×©×œ××•</div>
        </div>
      </div>

      {/* Pending orders alert */}
      {pendingOrders.length > 0 && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
          <div className="font-bold text-yellow-800 mb-2">âš ï¸ {pendingOrders.length} ×”×–×× ×•×ª ×××ª×™× ×•×ª ×œ××™×©×•×¨!</div>
          {pendingOrders.map(o => (
            <div key={o.id} className="text-sm text-yellow-700 py-1">
              #{o.orderNumber} - {o.customerName} | {o.total.toFixed(2)}â‚ª | {o.deliveryType === 'delivery' ? 'ğŸš— ××©×œ×•×—' : 'ğŸ“ ××™×¡×•×£'} | {timeAgo(o.createdAt)}
            </div>
          ))}
        </div>
      )}

      {/* Recent orders */}
      <div className="bg-white rounded-xl shadow-sm">
        <div className="p-4 border-b">
          <h3 className="font-bold text-gray-800">×”×–×× ×•×ª ××—×¨×•× ×•×ª</h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="py-3 px-4 text-right font-medium text-gray-600">××¡×³</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×œ×§×•×—</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×•×’</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×›×•×</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×˜×˜×•×¡</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×–××Ÿ</th>
              </tr>
            </thead>
            <tbody>
              {orders.slice(0, 10).map(o => (
                <tr key={o.id} className="order-row border-b">
                  <td className="py-3 px-4 font-bold">#{o.orderNumber}</td>
                  <td className="py-3 px-4">{o.customerName}</td>
                  <td className="py-3 px-4">{o.deliveryType === 'delivery' ? 'ğŸš—' : 'ğŸ“'}</td>
                  <td className="py-3 px-4 font-medium">{o.total.toFixed(2)}â‚ª</td>
                  <td className="py-3 px-4">
                    <span className={`status-badge ${STATUS_MAP[o.status].color}`}>
                      {STATUS_MAP[o.status].icon} {STATUS_MAP[o.status].label}
                    </span>
                  </td>
                  <td className="py-3 px-4 text-gray-500">{timeAgo(o.createdAt)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

function timeAgo(date) {
  const now = new Date();
  const diff = Math.floor((now - date) / 1000 / 60);
  if (diff < 1) return '×¢×›×©×™×•';
  if (diff < 60) return `×œ×¤× ×™ ${diff} ×“×§×³`;
  if (diff < 1440) return `×œ×¤× ×™ ${Math.floor(diff/60)} ×©×¢×•×ª`;
  return date.toLocaleDateString('he-IL');
}

// ==================== ORDERS PAGE ====================
function OrdersPage({ orders, setOrders, updateStatusDB, dbConnected }) {
  const [filter, setFilter] = useState('all');
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [search, setSearch] = useState('');
  const [actualWeights, setActualWeights] = useState({});
  const [savingWeights, setSavingWeights] = useState(false);

  // Initialize actualWeights when selecting an order
  useEffect(() => {
    if (selectedOrder) {
      const weights = {};
      selectedOrder.items.forEach((item, i) => {
        if (item.unit === 'kg') {
          weights[i] = item.actualQty != null ? item.actualQty : '';
        }
      });
      setActualWeights(weights);
    }
  }, [selectedOrder?.id]);

  const canEditWeights = selectedOrder && (selectedOrder.status === 'confirmed' || selectedOrder.status === 'ready');

  const handleWeightChange = (index, value) => {
    const num = value === '' ? '' : parseFloat(value);
    const item = selectedOrder.items[index];
    const maxAllowed = item.qty * 1.2;
    if (num !== '' && num > maxAllowed) return;
    setActualWeights(prev => ({ ...prev, [index]: value }));
  };

  const actualTotal = selectedOrder ? selectedOrder.items.reduce((sum, item, i) => {
    if (item.unit === 'kg' && actualWeights[i] !== undefined && actualWeights[i] !== '') {
      return sum + parseFloat(actualWeights[i]) * item.price;
    }
    return sum + item.qty * item.price;
  }, 0) : 0;

  const saveActualWeights = async () => {
    if (!dbConnected || !sb) return;
    setSavingWeights(true);
    try {
      for (const [index, weight] of Object.entries(actualWeights)) {
        const item = selectedOrder.items[parseInt(index)];
        if (weight !== '' && item.itemId) {
          await sb.rpc('update_order_item_actual', { p_item_id: item.itemId, p_actual_qty: parseFloat(weight) });
        }
      }
      await sb.rpc('update_order_total', { p_order_id: selectedOrder.id, p_total: parseFloat(actualTotal.toFixed(2)) });
      // Update local state
      setOrders(prev => prev.map(o => {
        if (o.id !== selectedOrder.id) return o;
        const updatedItems = o.items.map((item, i) => {
          if (actualWeights[i] !== undefined && actualWeights[i] !== '') {
            return { ...item, actualQty: parseFloat(actualWeights[i]) };
          }
          return item;
        });
        return { ...o, items: updatedItems, total: parseFloat(actualTotal.toFixed(2)) };
      }));
      setSelectedOrder(prev => ({
        ...prev,
        total: parseFloat(actualTotal.toFixed(2)),
        items: prev.items.map((item, i) => {
          if (actualWeights[i] !== undefined && actualWeights[i] !== '') {
            return { ...item, actualQty: parseFloat(actualWeights[i]) };
          }
          return item;
        })
      }));
      alert('×”××©×§×œ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!');
    } catch (err) {
      console.error('Error saving weights:', err);
      alert('×©×’×™××” ×‘×©××™×¨×ª ×”××©×§×œ×™×');
    }
    setSavingWeights(false);
  };

  const filtered = useMemo(() => {
    return orders.filter(o => {
      const matchStatus = filter === 'all' || o.status === filter;
      const matchSearch = !search || o.customerName.includes(search) || String(o.orderNumber).includes(search) || o.phone.includes(search);
      return matchStatus && matchSearch;
    });
  }, [orders, filter, search]);

  const updateStatus = (orderId, newStatus) => {
    if (updateStatusDB) {
      updateStatusDB(orderId, newStatus);
    } else {
      setOrders(prev => prev.map(o => o.id === orderId ? { ...o, status: newStatus } : o));
    }
    if (selectedOrder && selectedOrder.id === orderId) {
      setSelectedOrder(prev => ({ ...prev, status: newStatus }));
    }
  };

  if (selectedOrder) {
    return (
      <div className="fade-in">
        <button onClick={() => setSelectedOrder(null)} className="text-green-700 font-medium mb-4 hover:underline">â† ×—×–×¨×” ×œ×¨×©×™××”</button>

        <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-4">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <h2 className="text-xl font-bold">×”×–×× ×” #{selectedOrder.orderNumber}</h2>
            <span className={`status-badge ${STATUS_MAP[selectedOrder.status].color}`}>
              {STATUS_MAP[selectedOrder.status].icon} {STATUS_MAP[selectedOrder.status].label}
            </span>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
              <h3 className="font-bold text-gray-700 mb-2">×¤×¨×˜×™ ×œ×§×•×—</h3>
              <p>ğŸ‘¤ {selectedOrder.customerName}</p>
              <p>ğŸ“± <a href={`tel:${selectedOrder.phone}`} className="text-blue-600 underline" dir="ltr">{selectedOrder.phone}</a></p>
              {selectedOrder.email && <p>âœ‰ï¸ {selectedOrder.email}</p>}
            </div>
            <div>
              <h3 className="font-bold text-gray-700 mb-2">×¤×¨×˜×™ ××©×œ×•×—</h3>
              <p>{selectedOrder.deliveryType === 'delivery' ? 'ğŸš— ××©×œ×•×— ×œ: ' + selectedOrder.address : 'ğŸ“ ××™×¡×•×£ ×¢×¦××™'}</p>
              {selectedOrder.timeSlot && <p>ğŸ• ×—×œ×•×Ÿ ×–××Ÿ: {selectedOrder.timeSlot}</p>}
              <p>ğŸ“… {selectedOrder.createdAt.toLocaleString('he-IL')}</p>
              <p>ğŸ’³ {selectedOrder.paymentStatus === 'paid' ? 'âœ… ×©×•×œ×' : 'âŒ ×œ× ×©×•×œ×'}</p>
            </div>
          </div>

          {selectedOrder.notes && (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
              <span className="font-medium">ğŸ“ ×”×¢×¨×•×ª: </span>{selectedOrder.notes}
            </div>
          )}

          <h3 className="font-bold text-gray-700 mb-2">×¤×¨×™×˜×™×</h3>
          <div className="bg-gray-50 rounded-lg overflow-x-auto mb-4">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b">
                  <th className="py-2 px-4 text-right">××•×¦×¨</th>
                  <th className="py-2 px-4 text-right">×›××•×ª ××‘×•×§×©×ª</th>
                  {canEditWeights && <th className="py-2 px-4 text-right">××©×§×œ ×‘×¤×•×¢×œ</th>}
                  <th className="py-2 px-4 text-right">××—×™×¨</th>
                  <th className="py-2 px-4 text-right">×¡×”"×›</th>
                </tr>
              </thead>
              <tbody>
                {selectedOrder.items.map((item, i) => {
                  const effQty = (item.unit === 'kg' && actualWeights[i] !== undefined && actualWeights[i] !== '') ? parseFloat(actualWeights[i]) : item.qty;
                  return (
                    <tr key={i} className="border-b">
                      <td className="py-2 px-4">{item.name}</td>
                      <td className="py-2 px-4">{item.qty} {item.unit === 'kg' ? '×§"×’' : '×™×—×³'}</td>
                      {canEditWeights && (
                        <td className="py-2 px-4">
                          {item.unit === 'kg' ? (
                            <div className="flex items-center gap-1">
                              <input
                                type="number"
                                step="0.01"
                                min="0"
                                max={item.qty * 1.2}
                                value={actualWeights[i] ?? ''}
                                onChange={e => handleWeightChange(i, e.target.value)}
                                className="w-20 px-2 py-1 border rounded text-sm"
                                placeholder={item.qty.toString()}
                              />
                              <span className="text-xs text-gray-500">×§"×’</span>
                            </div>
                          ) : (
                            <span className="text-gray-400 text-xs">â€”</span>
                          )}
                        </td>
                      )}
                      <td className="py-2 px-4">{item.price.toFixed(2)}â‚ª</td>
                      <td className="py-2 px-4 font-medium">{(item.price * effQty).toFixed(2)}â‚ª</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
            <div>
              <div className="text-xl font-bold text-green-700">
                {canEditWeights ? `×¡×”"×› ×‘×¤×•×¢×œ: ${actualTotal.toFixed(2)}â‚ª` : `×¡×”"×›: ${selectedOrder.total.toFixed(2)}â‚ª`}
              </div>
              {canEditWeights && actualTotal !== selectedOrder.total && (
                <div className="text-sm text-gray-500">×¡×”"×› ××§×•×¨×™: {selectedOrder.total.toFixed(2)}â‚ª</div>
              )}
            </div>
            {canEditWeights && dbConnected && (
              <button onClick={saveActualWeights} disabled={savingWeights} className="bg-blue-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50">
                {savingWeights ? 'â³ ×©×•××¨...' : 'ğŸ’¾ ×©××•×¨ ××©×§×œ×™×'}
              </button>
            )}
          </div>
        </div>

        {/* Actions */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h3 className="font-bold text-gray-700 mb-4">×¤×¢×•×œ×•×ª</h3>
          <div className="flex flex-wrap gap-3">
            {selectedOrder.status === 'pending' && (
              <>
                <button onClick={() => updateStatus(selectedOrder.id, 'confirmed')} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700">âœ“ ××©×¨ ×”×–×× ×”</button>
                <button onClick={() => updateStatus(selectedOrder.id, 'cancelled')} className="bg-red-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-red-700">âœ• ×‘×˜×œ ×”×–×× ×”</button>
              </>
            )}
            {selectedOrder.status === 'confirmed' && (
              <button onClick={() => updateStatus(selectedOrder.id, 'ready')} className="bg-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-purple-700">ğŸ“¦ ×¡××Ÿ ×›××•×›×Ÿ</button>
            )}
            {selectedOrder.status === 'ready' && (
              <button onClick={() => updateStatus(selectedOrder.id, 'completed')} className="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700">âœ… ×¡××Ÿ ×›×”×•×©×œ×</button>
            )}
            <button onClick={() => window.print()} className="border border-gray-300 text-gray-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-50">ğŸ–¨ ×”×“×¤×¡</button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="fade-in">
      <h1 className="text-2xl font-bold text-gray-800 mb-6">ğŸ“‹ × ×™×”×•×œ ×”×–×× ×•×ª</h1>

      {/* Filters */}
      <div className="space-y-3 mb-4">
        <input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×©×, ×˜×œ×¤×•×Ÿ ××• ××¡×¤×¨ ×”×–×× ×”" className="px-4 py-2 rounded-lg border border-gray-200 bg-white w-full sm:w-64" />
        <div className="flex gap-2 flex-wrap">
          {['all', 'pending', 'confirmed', 'ready', 'completed', 'cancelled'].map(s => (
            <button key={s} onClick={() => setFilter(s)} className={`px-3 py-2 rounded-lg text-sm font-medium ${filter === s ? 'bg-green-600 text-white' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}`}>
              {s === 'all' ? '×”×›×œ' : STATUS_MAP[s].icon + ' ' + STATUS_MAP[s].label}
            </button>
          ))}
        </div>
      </div>

      {/* Orders table */}
      <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
        <table className="w-full text-sm min-w-max">
          <thead className="bg-gray-50">
            <tr>
              <th className="py-3 px-4 text-right font-medium text-gray-600">××¡×³</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×œ×§×•×—</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×˜×œ×¤×•×Ÿ</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×•×’</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¤×¨×™×˜×™×</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×›×•×</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×˜×˜×•×¡</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×–××Ÿ</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map(o => (
              <tr key={o.id} className="order-row border-b cursor-pointer" onClick={() => setSelectedOrder(o)}>
                <td className="py-3 px-4 font-bold">#{o.orderNumber}</td>
                <td className="py-3 px-4">{o.customerName}</td>
                <td className="py-3 px-4 text-gray-500" dir="ltr">{o.phone}</td>
                <td className="py-3 px-4">{o.deliveryType === 'delivery' ? 'ğŸš— ××©×œ×•×—' : 'ğŸ“ ××™×¡×•×£'}</td>
                <td className="py-3 px-4">{o.items.length} ×¤×¨×™×˜×™×</td>
                <td className="py-3 px-4 font-medium">{o.total.toFixed(2)}â‚ª</td>
                <td className="py-3 px-4">
                  <span className={`status-badge ${STATUS_MAP[o.status].color}`}>
                    {STATUS_MAP[o.status].icon} {STATUS_MAP[o.status].label}
                  </span>
                </td>
                <td className="py-3 px-4 text-gray-500 text-xs">{timeAgo(o.createdAt)}</td>
                <td className="py-3 px-4">
                  {o.status === 'pending' && (
                    <button onClick={(e) => { e.stopPropagation(); updateStatus(o.id, 'confirmed'); }} className="text-blue-600 hover:underline text-xs">××©×¨</button>
                  )}
                  {o.status === 'confirmed' && (
                    <button onClick={(e) => { e.stopPropagation(); updateStatus(o.id, 'ready'); }} className="text-purple-600 hover:underline text-xs">××•×›×Ÿ</button>
                  )}
                  {o.status === 'ready' && (
                    <button onClick={(e) => { e.stopPropagation(); updateStatus(o.id, 'completed'); }} className="text-green-600 hover:underline text-xs">×”×•×©×œ×</button>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        {filtered.length === 0 && (
          <div className="text-center py-12 text-gray-400">
            <p>××™×Ÿ ×”×–×× ×•×ª ××ª××™××•×ª</p>
          </div>
        )}
      </div>
    </div>
  );
}

// ==================== PRICING PAGE ====================
function PricingPage({ products, setProducts, dbConnected, wholesaleStatus, onFetchWholesale }) {
  const [editPrices, setEditPrices] = useState({});
  const [saved, setSaved] = useState(false);
  const [categoryFilter, setCategoryFilter] = useState('all');

  const initPrices = () => {
    const prices = {};
    products.forEach(p => { prices[p.id] = p.price; });
    setEditPrices(prices);
  };

  useEffect(() => { initPrices(); }, []);

  const handlePriceChange = (id, value) => {
    setEditPrices(prev => ({ ...prev, [id]: parseFloat(value) || 0 }));
  };

  const saveAllPrices = async () => {
    setProducts(prev => prev.map(p => ({ ...p, price: editPrices[p.id] || p.price })));

    // Save to Supabase via RPC function (bypasses RLS)
    if (sb && dbConnected) {
      for (const p of products) {
        const newPrice = editPrices[p.id];
        if (newPrice && newPrice > 0) {
          await sb.rpc('upsert_daily_price', { p_product_id: p.id, p_price: newPrice, p_available: p.active !== false });
        }
      }
    }

    setSaved(true);
    setTimeout(() => setSaved(false), 3000);
  };

  const filtered = categoryFilter === 'all' ? products : products.filter(p => p.category === categoryFilter);

  return (
    <div className="fade-in">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-3">
        <div>
          <h1 className="text-xl sm:text-2xl font-bold text-gray-800">ğŸ’° ×¢×“×›×•×Ÿ ××—×™×¨×™× ×™×•××™</h1>
          <p className="text-gray-500 text-sm">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: {new Date().toLocaleDateString('he-IL')} | {new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}</p>
        </div>
        <button
          onClick={saveAllPrices}
          className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition w-full sm:w-auto"
        >
          ğŸ’¾ ×©××•×¨ ××ª ×›×œ ×”××—×™×¨×™×
        </button>
      </div>

      {saved && (
        <div className="bg-green-100 border border-green-300 text-green-800 rounded-lg p-3 mb-4 font-medium">
          âœ… ×”××—×™×¨×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!
        </div>
      )}

      {/* Category filter */}
      <div className="flex gap-2 mb-4 flex-wrap">
        <button onClick={() => setCategoryFilter('all')} className={`px-3 py-2 rounded-lg text-sm font-medium ${categoryFilter === 'all' ? 'bg-green-600 text-white' : 'bg-white text-gray-600 border'}`}>×”×›×œ</button>
        {Object.entries(CATEGORY_MAP).map(([key, label]) => (
          <button key={key} onClick={() => setCategoryFilter(key)} className={`px-3 py-2 rounded-lg text-sm font-medium ${categoryFilter === key ? 'bg-green-600 text-white' : 'bg-white text-gray-600 border'}`}>{label}</button>
        ))}
      </div>

      <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
        <table className="w-full text-sm min-w-max">
          <thead className="bg-gray-50">
            <tr>
              <th className="py-3 px-4 text-right font-medium text-gray-600"></th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">××•×¦×¨</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×§×˜×’×•×¨×™×”</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×™×—×™×“×”</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">××—×™×¨ × ×•×›×—×™</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">××—×™×¨ ×—×“×© (â‚ª)</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×©×™× ×•×™</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¤×¢×™×œ</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map(p => {
              const newPrice = editPrices[p.id] || p.price;
              const change = ((newPrice - p.price) / p.price * 100);
              return (
                <tr key={p.id} className="border-b hover:bg-gray-50">
                  <td className="py-3 px-4">{getProductImage(p.name, p.imageUrl) ? <img src={getProductImage(p.name, p.imageUrl)} alt={p.name} className="w-10 h-10 rounded-lg object-cover" /> : <span className="text-xl">{p.image}</span>}</td>
                  <td className="py-3 px-4 font-medium">{p.name}</td>
                  <td className="py-3 px-4 text-gray-500">{CATEGORY_MAP[p.category]}</td>
                  <td className="py-3 px-4">{p.unit === 'kg' ? '×§"×’' : '×™×—×™×“×”'}</td>
                  <td className="py-3 px-4">{p.price.toFixed(2)}â‚ª</td>
                  <td className="py-3 px-4">
                    <input
                      type="number"
                      step="0.10"
                      min="0"
                      value={editPrices[p.id] || ''}
                      onChange={e => handlePriceChange(p.id, e.target.value)}
                      className="price-input px-3 py-2 rounded-lg border border-gray-200 text-center"
                      dir="ltr"
                    />
                  </td>
                  <td className="py-3 px-4">
                    {change !== 0 && (
                      <span className={`text-xs font-bold ${change > 0 ? 'text-red-600' : 'text-green-600'}`}>
                        {change > 0 ? 'â†‘' : 'â†“'} {Math.abs(change).toFixed(1)}%
                      </span>
                    )}
                  </td>
                  <td className="py-3 px-4">
                    <div
                      className={`toggle-switch ${p.active ? 'active' : ''}`}
                      onClick={() => setProducts(prev => prev.map(prod => prod.id === p.id ? { ...prod, active: !prod.active } : prod))}
                    ></div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* Wholesale price fetch */}
      <div className="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4">
        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-2">
          <div>
            <h3 className="font-bold text-blue-800">ğŸª ××—×™×¨×™× ×¡×™×˜×•× ××™×™× - ××•×¢×¦×ª ×”×¦××—×™×</h3>
            <p className="text-sm text-blue-600">××ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ×›×œ ×™×•× ×‘-07:30 | ×¢×“×™×¤×•×ª: ××•×‘×—×¨ â† ×¡×•×’ ××³</p>
          </div>
          <button
            onClick={onFetchWholesale}
            disabled={wholesaleStatus.loading}
            className={`${wholesaleStatus.loading ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'} text-white px-4 py-2 rounded-lg font-bold text-sm transition whitespace-nowrap`}
          >
            {wholesaleStatus.loading ? 'â³ ××¢×“×›×Ÿ...' : 'ğŸ”„ ×¢×“×›×Ÿ ××—×™×¨×™× ×¢×›×©×™×•'}
          </button>
        </div>
        {wholesaleStatus.lastFetch && (
          <p className="text-xs text-green-700 bg-green-50 rounded p-2 mt-2">
            âœ… ×¢×•×“×›× ×• {wholesaleStatus.count} ××•×¦×¨×™× | {wholesaleStatus.lastFetch.toLocaleString('he-IL')}
          </p>
        )}
        {wholesaleStatus.error && (
          <p className="text-xs text-red-700 bg-red-50 rounded p-2 mt-2">âŒ {wholesaleStatus.error}</p>
        )}
        <p className="text-xs text-blue-400 mt-2">××§×•×¨: plants.moonsite.co.il | ×™×¨×§×•×ª ×‘×œ×‘×“ (×¤×™×¨×•×ª, ×¢×©×‘×™ ×ª×™×‘×•×œ ×•×—×•××¨×™ ×’×œ× ×™×© ×œ×¢×“×›×Ÿ ×™×“× ×™×ª)</p>
      </div>
    </div>
  );
}

// ==================== PRODUCTS PAGE ====================
function ProductsPage({ products, setProducts, dbConnected }) {
  const [showForm, setShowForm] = useState(false);
  const [editProduct, setEditProduct] = useState(null);
  const [form, setForm] = useState({ name: '', category: 'fruits', unit: 'kg', price: '', image: 'ğŸ', active: true });

  const startEdit = (product) => {
    setEditProduct(product);
    setForm({ name: product.name, category: product.category, unit: product.unit, price: product.price, image: product.image, active: product.active });
    setShowForm(true);
  };

  const startNew = () => {
    setEditProduct(null);
    setForm({ name: '', category: 'fruits', unit: 'kg', price: '', image: 'ğŸ', active: true });
    setShowForm(true);
  };

  const saveProduct = async () => {
    if (!form.name || !form.price) return;
    if (editProduct) {
      setProducts(prev => prev.map(p => p.id === editProduct.id ? { ...p, ...form, price: parseFloat(form.price) } : p));
      if (sb && dbConnected) {
        await sb.from('products').update({
          name_he: form.name, category: form.category, unit: form.unit,
          image_emoji: form.image, is_active: form.active
        }).eq('id', editProduct.id);
      }
    } else {
      if (sb && dbConnected) {
        const { data, error } = await sb.from('products').insert({
          name_he: form.name, category: form.category, unit: form.unit,
          image_emoji: form.image, is_active: form.active
        }).select().single();
        if (data) {
          setProducts(prev => [...prev, { id: data.id, name: form.name, category: form.category, unit: form.unit, price: parseFloat(form.price), active: form.active, image: form.image }]);
        }
      } else {
        const newId = Math.max(0, ...products.map(p => typeof p.id === 'number' ? p.id : 0)) + 1;
        setProducts(prev => [...prev, { id: newId, ...form, price: parseFloat(form.price) }]);
      }
    }
    setShowForm(false);
  };

  const deleteProduct = async (id) => {
    if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××•×¦×¨ ×–×”?')) {
      setProducts(prev => prev.filter(p => p.id !== id));
      if (sb && dbConnected) {
        await sb.from('products').delete().eq('id', id);
      }
    }
  };

  const toggleActive = async (product) => {
    setProducts(prev => prev.map(p => p.id === product.id ? { ...p, active: !p.active } : p));
    if (sb && dbConnected) {
      await sb.from('products').update({ is_active: !product.active }).eq('id', product.id);
    }
  };

  const emojis = ['ğŸ','ğŸŒ','ğŸ‡','ğŸ‰','ğŸ','ğŸ‘','ğŸ“','ğŸŠ','ğŸ‹','ğŸ¥­','ğŸ¥‘','ğŸ','ğŸ¥','ğŸ’','ğŸ…','ğŸ¥’','ğŸ«‘','ğŸ¥¬','ğŸ¥•','ğŸ§…','ğŸ¥”','ğŸ†','ğŸ ','ğŸ¥¦','ğŸŒ¿','ğŸ§„'];

  return (
    <div className="fade-in">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-3">
        <h1 className="text-xl sm:text-2xl font-bold text-gray-800">ğŸ“¦ × ×™×”×•×œ ××•×¦×¨×™×</h1>
        <button onClick={startNew} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 w-full sm:w-auto">+ ×”×•×¡×£ ××•×¦×¨</button>
      </div>

      {/* Product form modal */}
      {showForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 w-full max-w-md">
            <h2 className="text-xl font-bold mb-4">{editProduct ? '×¢×¨×•×š ××•×¦×¨' : '××•×¦×¨ ×—×“×©'}</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">×©× ×”××•×¦×¨ *</label>
                <input type="text" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className="w-full px-4 py-2 rounded-lg border border-gray-200" />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">×§×˜×’×•×¨×™×”</label>
                  <select value={form.category} onChange={e => setForm({ ...form, category: e.target.value })} className="w-full px-4 py-2 rounded-lg border border-gray-200">
                    {Object.entries(CATEGORY_MAP).map(([key, label]) => (
                      <option key={key} value={key}>{label}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">×™×—×™×“×ª ××“×™×“×”</label>
                  <select value={form.unit} onChange={e => setForm({ ...form, unit: e.target.value })} className="w-full px-4 py-2 rounded-lg border border-gray-200">
                    <option value="kg">×§"×’</option>
                    <option value="unit">×™×—×™×“×”</option>
                  </select>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">××—×™×¨ (â‚ª) *</label>
                <input type="number" step="0.10" value={form.price} onChange={e => setForm({ ...form, price: e.target.value })} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">××™×™×§×•×Ÿ</label>
                <div className="flex flex-wrap gap-2">
                  {emojis.map(e => (
                    <button key={e} onClick={() => setForm({ ...form, image: e })} className={`text-2xl p-1 rounded ${form.image === e ? 'bg-green-100 ring-2 ring-green-500' : ''}`}>{e}</button>
                  ))}
                </div>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={() => setShowForm(false)} className="flex-1 border border-gray-300 py-2 rounded-lg font-medium">×‘×™×˜×•×œ</button>
              <button onClick={saveProduct} className="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">×©××•×¨</button>
            </div>
          </div>
        </div>
      )}

      {/* Products grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {products.map(p => (
          <div key={p.id} className={`bg-white rounded-xl p-4 shadow-sm border ${!p.active ? 'opacity-50' : ''}`}>
            <div className="flex items-center gap-3 mb-3">
              {getProductImage(p.name, p.imageUrl) ? (
                <img src={getProductImage(p.name, p.imageUrl)} alt={p.name} className="w-14 h-14 rounded-lg object-cover" />
              ) : (
                <span className="text-3xl">{p.image}</span>
              )}
              <div className="flex-1">
                <h3 className="font-bold">{p.name}</h3>
                <p className="text-xs text-gray-500">{CATEGORY_MAP[p.category]} | {p.unit === 'kg' ? '×§"×’' : '×™×—×™×“×”'}</p>
              </div>
              <span className="text-lg font-bold text-green-700">{p.price.toFixed(2)}â‚ª</span>
            </div>
            <div className="flex gap-2">
              <button onClick={() => startEdit(p)} className="flex-1 text-xs border border-blue-300 text-blue-600 py-1 rounded hover:bg-blue-50">âœï¸ ×¢×¨×•×š</button>
              <button onClick={() => toggleActive(p)} className={`flex-1 text-xs border py-1 rounded ${p.active ? 'border-gray-300 text-gray-600 hover:bg-gray-50' : 'border-green-300 text-green-600 hover:bg-green-50'}`}>
                {p.active ? 'ğŸš« ×”×©×‘×ª' : 'âœ… ×”×¤×¢×œ'}
              </button>
              <button onClick={() => deleteProduct(p.id)} className="text-xs border border-red-300 text-red-600 py-1 px-2 rounded hover:bg-red-50">ğŸ—‘</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ==================== SETTINGS PAGE ====================
function SettingsPage({ settings, setSettings, dbConnected }) {
  const [saved, setSaved] = useState(false);
  const [saving, setSaving] = useState(false);
  const [saveError, setSaveError] = useState('');

  const handleChange = (key, value) => {
    setSettings(prev => ({ ...prev, [key]: value }));
  };

  const save = async () => {
    setSaving(true);
    setSaveError('');
    try {
      if (sb && dbConnected) {
        const settingsMap = {
          'store_name': settings.name,
          'ordering_open': String(settings.orderingOpen),
          'ordering_start_hour': settings.orderingStartHour,
          'ordering_end_hour': settings.orderingEndHour,
          'delivery_fee': String(settings.deliveryFee),
          'min_order_amount': String(settings.minOrderAmount),
          'delivery_enabled': String(settings.deliveryEnabled),
          'pickup_enabled': String(settings.pickupEnabled),
          'store_address': settings.address,
          'store_phone': settings.phone,
          'delivery_area': settings.deliveryArea,
          'emailjs_enabled': String(settings.emailjsEnabled),
          'emailjs_service_id': settings.emailjsServiceId,
          'emailjs_template_id': settings.emailjsTemplateId,
          'emailjs_public_key': settings.emailjsPublicKey,
          'emailjs_to_email': settings.emailjsToEmail,
          'whatsapp_enabled': String(settings.whatsappEnabled),
          'whatsapp_phone': settings.whatsappPhone,
          'twilio_account_sid': settings.twilioAccountSid,
          'twilio_auth_token': settings.twilioAuthToken,
          'twilio_whatsapp_from': settings.twilioWhatsappFrom,
          'customer_whatsapp_enabled': String(settings.customerWhatsappEnabled),
          'whatsapp_business_phone_id': settings.whatsappBusinessPhoneId,
          'whatsapp_business_token': settings.whatsappBusinessToken,
          'delivery_time_slots': settings.deliveryTimeSlots,
        };
        for (const [key, value] of Object.entries(settingsMap)) {
          await sb
            .from('store_settings')
            .upsert({ setting_key: key, setting_value: value || '' }, { onConflict: 'setting_key' });
        }
      }
      setSaved(true);
      setTimeout(() => setSaved(false), 3000);
    } catch (err) {
      console.error('Error saving settings:', err);
      setSaveError('×©×’×™××” ×‘×©××™×¨×ª ×”×”×’×“×¨×•×ª: ' + err.message);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="fade-in">
      <h1 className="text-2xl font-bold text-gray-800 mb-6">âš™ï¸ ×”×’×“×¨×•×ª ×—× ×•×ª</h1>

      {saved && (
        <div className="bg-green-100 border border-green-300 text-green-800 rounded-lg p-3 mb-4 font-medium">
          âœ… ×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!
        </div>
      )}

      <div className="space-y-6">
        {/* Ordering window */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ• ×—×œ×•×Ÿ ×”×–×× ×•×ª</h2>

          <div className="flex items-center justify-between mb-6 bg-gray-50 rounded-lg p-4">
            <div>
              <h3 className="font-bold text-lg">{settings.orderingOpen ? 'âœ… ×”×–×× ×•×ª ×¤×ª×•×—×•×ª' : 'âŒ ×”×–×× ×•×ª ×¡×’×•×¨×•×ª'}</h3>
              <p className="text-sm text-gray-500">×œ×—×¥ ×›×“×™ {settings.orderingOpen ? '×œ×¡×’×•×¨' : '×œ×¤×ª×•×—'} ××ª ×”×”×–×× ×•×ª</p>
            </div>
            <div
              className={`toggle-switch ${settings.orderingOpen ? 'active' : ''}`}
              onClick={() => handleChange('orderingOpen', !settings.orderingOpen)}
            ></div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×©×¢×ª ×¤×ª×™×—×”</label>
              <input type="time" value={settings.orderingStartHour} onChange={e => handleChange('orderingStartHour', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×©×¢×ª ×¡×’×™×¨×”</label>
              <input type="time" value={settings.orderingEndHour} onChange={e => handleChange('orderingEndHour', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
          </div>
        </div>

        {/* Delivery */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸš— ×”×’×“×¨×•×ª ××©×œ×•×—</h2>

          <div className="flex items-center justify-between mb-4">
            <span className="font-medium">××¤×©×¨ ××©×œ×•×—×™×</span>
            <div className={`toggle-switch ${settings.deliveryEnabled ? 'active' : ''}`} onClick={() => handleChange('deliveryEnabled', !settings.deliveryEnabled)}></div>
          </div>

          <div className="flex items-center justify-between mb-4">
            <span className="font-medium">××¤×©×¨ ××™×¡×•×£ ×¢×¦××™</span>
            <div className={`toggle-switch ${settings.pickupEnabled ? 'active' : ''}`} onClick={() => handleChange('pickupEnabled', !settings.pickupEnabled)}></div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×¢××œ×ª ××©×œ×•×— (â‚ª)</label>
              <input type="number" value={settings.deliveryFee} onChange={e => handleChange('deliveryFee', parseFloat(e.target.value) || 0)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×”×–×× ×” ××™× ×™××œ×™×ª (â‚ª)</label>
              <input type="number" value={settings.minOrderAmount} onChange={e => handleChange('minOrderAmount', parseFloat(e.target.value) || 0)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
          </div>

          <div className="mt-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">××–×•×¨ ××©×œ×•×—</label>
            <input type="text" value={settings.deliveryArea} onChange={e => handleChange('deliveryArea', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" />
          </div>

          <div className="mt-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">ğŸ• ×—×œ×•× ×•×ª ×–××Ÿ ×œ××©×œ×•×—/××™×¡×•×£ (××•×¤×¨×“×™× ×‘×¤×¡×™×§×™×)</label>
            <input type="text" value={settings.deliveryTimeSlots} onChange={e => handleChange('deliveryTimeSlots', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" placeholder="08:00-10:00,10:00-12:00,..." />
            <p className="text-xs text-gray-400 mt-1">×”×œ×§×•×— ×™×‘×—×¨ ×—×œ×•×Ÿ ×–××Ÿ ×‘×ª×”×œ×™×š ×”×”×–×× ×”. ×“×•×’××”: 08:00-10:00,10:00-12:00,12:00-14:00</p>
          </div>
        </div>

        {/* Store info */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ“ ×¤×¨×˜×™ ×”×—× ×•×ª</h2>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×©× ×”×—× ×•×ª</label>
              <input type="text" value={settings.name} onChange={e => handleChange('name', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×›×ª×•×‘×ª</label>
              <input type="text" value={settings.address} onChange={e => handleChange('address', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×˜×œ×¤×•×Ÿ</label>
              <input type="text" value={settings.phone} onChange={e => handleChange('phone', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
          </div>
        </div>

        {/* Email Notifications */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ“§ ×”×ª×¨××•×ª ××™××™×™×œ (EmailJS)</h2>

          <div className="flex items-center justify-between mb-4 bg-gray-50 rounded-lg p-4">
            <div>
              <h3 className="font-bold">{settings.emailjsEnabled ? 'âœ… ×”×ª×¨××•×ª ××™××™×™×œ ×¤×¢×™×œ×•×ª' : 'âŒ ×”×ª×¨××•×ª ××™××™×™×œ ×›×‘×•×™×•×ª'}</h3>
              <p className="text-sm text-gray-500">×©×œ×— ××™××™×™×œ ×›×©××ª×§×‘×œ×ª ×”×–×× ×” ×—×“×©×”</p>
            </div>
            <div
              className={`toggle-switch ${settings.emailjsEnabled ? 'active' : ''}`}
              onClick={() => handleChange('emailjsEnabled', !settings.emailjsEnabled)}
            ></div>
          </div>

          {settings.emailjsEnabled && (
            <div className="space-y-3">
              <p className="text-xs text-gray-500 bg-blue-50 border border-blue-200 rounded-lg p-3">
                ğŸ“Œ ×”×™×¨×©× ×‘×—×™× × ×‘-<a href="https://www.emailjs.com" target="_blank" className="text-blue-600 underline" dir="ltr">emailjs.com</a> â† ×¦×•×¨ ×©×™×¨×•×ª (Gmail) + ×ª×‘× ×™×ª ×¢× ×”××©×ª× ×™×: {'{'}order_number{'}'}, {'{'}customer_name{'}'}, {'{'}customer_phone{'}'}, {'{'}delivery_type{'}'}, {'{'}address{'}'}, {'{'}items{'}'}, {'{'}total{'}'}, {'{'}notes{'}'}
              </p>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service ID</label>
                  <input type="text" value={settings.emailjsServiceId} onChange={e => handleChange('emailjsServiceId', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="service_xxxxxxx" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Template ID</label>
                  <input type="text" value={settings.emailjsTemplateId} onChange={e => handleChange('emailjsTemplateId', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="template_xxxxxxx" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Public Key</label>
                  <input type="text" value={settings.emailjsPublicKey} onChange={e => handleChange('emailjsPublicKey', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="xxxxxxxxxxxx" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">××™××™×™×œ ×œ×§×‘×œ×ª ×”×ª×¨××•×ª</label>
                  <input type="email" value={settings.emailjsToEmail} onChange={e => handleChange('emailjsToEmail', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="admin@example.com" />
                </div>
              </div>
            </div>
          )}
        </div>

        {/* WhatsApp Notifications */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ’¬ ×”×ª×¨××•×ª ×•×•××˜×¡××¤ (Twilio)</h2>

          <div className="flex items-center justify-between mb-4 bg-gray-50 rounded-lg p-4">
            <div>
              <h3 className="font-bold">{settings.whatsappEnabled ? 'âœ… ×”×ª×¨××•×ª ×•×•××˜×¡××¤ ×¤×¢×™×œ×•×ª' : 'âŒ ×”×ª×¨××•×ª ×•×•××˜×¡××¤ ×›×‘×•×™×•×ª'}</h3>
              <p className="text-sm text-gray-500">×©×œ×— ×”×•×“×¢×ª ×•×•××˜×¡××¤ ×›×©××ª×§×‘×œ×ª ×”×–×× ×” ×—×“×©×”</p>
            </div>
            <div
              className={`toggle-switch ${settings.whatsappEnabled ? 'active' : ''}`}
              onClick={() => handleChange('whatsappEnabled', !settings.whatsappEnabled)}
            ></div>
          </div>

          {settings.whatsappEnabled && (
            <div className="space-y-3">
              <p className="text-xs text-gray-500 bg-green-50 border border-green-200 rounded-lg p-3">
                ğŸ“Œ ×”×™×¨×©× ×‘-<a href="https://www.twilio.com/whatsapp" target="_blank" className="text-green-700 underline" dir="ltr">twilio.com/whatsapp</a> ×•×”×¤×¢×œ ××ª Twilio Sandbox for WhatsApp. ×”×¢×ª×§ ××ª Account SID, Auth Token ×•××¡×¤×¨ ×”-WhatsApp From ××”×§×•× ×¡×•×œ.
              </p>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×§×‘×œ×ª ×”×ª×¨××•×ª (×¢× ×§×™×“×•××ª ××“×™× ×”)</label>
                  <input type="text" value={settings.whatsappPhone} onChange={e => handleChange('whatsappPhone', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="972501234567" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Account SID</label>
                  <input type="text" value={settings.twilioAccountSid} onChange={e => handleChange('twilioAccountSid', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Auth Token</label>
                  <input type="password" value={settings.twilioAuthToken} onChange={e => handleChange('twilioAuthToken', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">WhatsApp From Number</label>
                  <input type="text" value={settings.twilioWhatsappFrom} onChange={e => handleChange('twilioWhatsappFrom', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="14155238886" />
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Customer WhatsApp Business Notifications */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ’¬ ×”×•×“×¢×•×ª ×•×•××˜×¡××¤ ×œ×œ×§×•×—×•×ª (WhatsApp Business)</h2>

          <div className="flex items-center justify-between mb-4 bg-gray-50 rounded-lg p-4">
            <div>
              <h3 className="font-bold">{settings.customerWhatsappEnabled ? 'âœ… ×”×•×“×¢×•×ª ×œ×œ×§×•×—×•×ª ×¤×¢×™×œ×•×ª' : 'âŒ ×”×•×“×¢×•×ª ×œ×œ×§×•×—×•×ª ×›×‘×•×™×•×ª'}</h3>
              <p className="text-sm text-gray-500">×©×œ×— ×”×•×“×¢×ª ×•×•××˜×¡××¤ ×œ×œ×§×•×— ×›×©×¡×˜×˜×•×¡ ×”×”×–×× ×” ××©×ª× ×”</p>
            </div>
            <div
              className={`toggle-switch ${settings.customerWhatsappEnabled ? 'active' : ''}`}
              onClick={() => handleChange('customerWhatsappEnabled', !settings.customerWhatsappEnabled)}
            ></div>
          </div>

          {settings.customerWhatsappEnabled && (
            <div className="space-y-3">
              <p className="text-xs text-gray-500 bg-blue-50 border border-blue-200 rounded-lg p-3">
                ğŸ“Œ × ×“×¨×© ×—×©×‘×•×Ÿ WhatsApp Business API ×“×¨×š <a href="https://business.facebook.com" target="_blank" className="text-blue-600 underline">Meta Business Suite</a>. ×”×›× ×¡ ××ª Phone Number ID ×•××ª Access Token ××”×”×’×“×¨×•×ª.
              </p>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Phone Number ID</label>
                  <input type="text" value={settings.whatsappBusinessPhoneId} onChange={e => handleChange('whatsappBusinessPhoneId', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="1234567890" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Access Token</label>
                  <input type="text" value={settings.whatsappBusinessToken} onChange={e => handleChange('whatsappBusinessToken', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="EAAxxxxxxx..." />
                </div>
              </div>
              <div className="bg-green-50 border border-green-200 rounded-lg p-3 text-xs text-green-800">
                <p className="font-bold mb-1">×”×•×“×¢×•×ª ×©×™×™×©×œ×—×•:</p>
                <p>âœ“ ××™×©×•×¨ â†’ "×”×–×× ×ª×š ××•×©×¨×” ×•××˜×•×¤×œ×ª! ğŸ‰"</p>
                <p>âœ“ ××•×›×Ÿ â†’ "××¤×©×¨ ×œ××¡×•×£" / "×”××©×œ×•×— ×‘×“×¨×š ××œ×™×š"</p>
                <p>âœ“ ×”×•×©×œ× â†’ "×ª×•×“×” ×©×§× ×™×ª ×‘×‘×¨×›×ª ×”×©×“×”! ğŸ™"</p>
                <p>âœ“ ×‘×•×˜×œ â†’ "×”×–×× ×ª×š ×‘×•×˜×œ×”. ×œ×¤×¨×˜×™×: ..."</p>
              </div>
            </div>
          )}
        </div>

        {saveError && (
          <div className="bg-red-100 border border-red-300 text-red-800 rounded-lg p-3 mb-4 font-medium">
            âŒ {saveError}
          </div>
        )}

        <button onClick={save} disabled={saving} className={`${saving ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700'} text-white px-8 py-3 rounded-lg font-bold transition w-full md:w-auto`}>
          {saving ? 'â³ ×©×•××¨...' : 'ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª'}
        </button>

        {!dbConnected && (
          <p className="text-sm text-yellow-600 mt-2">âš ï¸ ×œ× ××—×•×‘×¨ ×œ-Supabase - ×”×©×™× ×•×™×™× × ×©××¨×™× ×¨×§ ××§×•××™×ª</p>
        )}
      </div>
    </div>
  );
}

// ==================== NOTIFICATION SOUND ====================
function playNotificationSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.15);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.3);
      osc.start(ctx.currentTime + i * 0.15);
      osc.stop(ctx.currentTime + i * 0.15 + 0.3);
    });
  } catch (e) { console.log('Audio not supported'); }
}

// ==================== EMAIL & WHATSAPP NOTIFICATIONS ====================
async function sendEmailNotification(order, settings) {
  if (!settings.emailjsEnabled || !settings.emailjsServiceId || !settings.emailjsTemplateId || !settings.emailjsPublicKey) return;
  try {
    const itemsList = order.items.map(i => `${i.name} x${i.qty} ${i.unit === 'kg' ? '×§"×’' : '×™×—×³'}`).join(', ');
    await emailjs.send(settings.emailjsServiceId, settings.emailjsTemplateId, {
      to_email: settings.emailjsToEmail,
      order_number: order.orderNumber,
      customer_name: order.customerName,
      customer_phone: order.phone,
      delivery_type: order.deliveryType === 'delivery' ? '××©×œ×•×—' : '××™×¡×•×£ ×¢×¦××™',
      address: order.address || '-',
      items: itemsList,
      total: order.total.toFixed(2),
      notes: order.notes || '-',
    }, settings.emailjsPublicKey);
    console.log('Email notification sent');
  } catch (err) {
    console.error('Email notification failed:', err);
  }
}

// ==================== CUSTOMER WHATSAPP STATUS NOTIFICATIONS ====================
async function sendCustomerStatusWhatsApp(order, newStatus, settings) {
  if (!settings.customerWhatsappEnabled || !settings.whatsappBusinessPhoneId || !settings.whatsappBusinessToken) return;
  try {
    // Format customer phone: strip dashes/spaces, "05X" â†’ "9725X"
    let phone = order.phone.replace(/[-\s]/g, '');
    if (phone.startsWith('05')) phone = '972' + phone.slice(1);
    if (phone.startsWith('0')) phone = '972' + phone.slice(1);

    const statusMessages = {
      confirmed: `×©×œ×•× ${order.customerName}, ×”×–×× ×ª×š #${order.orderNumber} ×‘×‘×¨×›×ª ×”×©×“×” ××•×©×¨×” ×•××˜×•×¤×œ×ª! ğŸ‰`,
      ready: order.deliveryType === 'delivery'
        ? `×©×œ×•× ${order.customerName}, ×”×–×× ×ª×š #${order.orderNumber} ××•×›× ×”! ×”××©×œ×•×— ×‘×“×¨×š ××œ×™×š ğŸš—`
        : `×©×œ×•× ${order.customerName}, ×”×–×× ×ª×š #${order.orderNumber} ××•×›× ×”! ××¤×©×¨ ×œ××¡×•×£ ×: ${settings.address || '×”×—× ×•×ª'} ğŸ“`,
      completed: `×ª×•×“×” ×©×§× ×™×ª ×‘×‘×¨×›×ª ×”×©×“×”! ğŸ™ × ×©××— ×œ×¨××•×ª×š ×©×•×‘.`,
      cancelled: `×©×œ×•× ${order.customerName}, ×”×–×× ×ª×š #${order.orderNumber} ×‘×•×˜×œ×”. ×œ×¤×¨×˜×™×: ${settings.phone || ''}`,
    };

    const message = statusMessages[newStatus];
    if (!message) return;

    const url = `https://graph.facebook.com/v21.0/${settings.whatsappBusinessPhoneId}/messages`;
    await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${settings.whatsappBusinessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        messaging_product: 'whatsapp',
        to: phone,
        type: 'text',
        text: { body: message },
      }),
    });
    console.log(`Customer WhatsApp sent to ${phone} for status: ${newStatus}`);
  } catch (err) {
    console.error('Customer WhatsApp notification failed:', err);
  }
}

// ==================== WHOLESALE PRICE FETCHING ====================
// Map store product names â†’ wholesale product name keywords
const WHOLESALE_MAP = {
  '×¢×’×‘× ×™×•×ª': ['×¢×’×‘× ×™×•×ª', '×¢×’×‘× ×™×•×ª ××©×›×•×œ×•×ª'],
  '×¢×’×‘× ×™×•×ª ×©×¨×™': ['×¢×’×‘× ×™×•×ª ×©×¨×™'],
  '××œ×¤×¤×•× ×™×': ['××œ×¤×¤×•×Ÿ'],
  '×¤×œ×¤×œ ××“×•×': ['×¤×œ×¤×œ ××“×•×'],
  '×¤×œ×¤×œ ×™×¨×•×§': ['×¤×œ×¤×œ ×™×¨×•×§'],
  '×¤×œ×¤×œ ×¦×”×•×‘': ['×¤×œ×¤×œ ×¦×”×•×‘'],
  '×¤×œ×¤×œ ×›×ª×•×': ['×¤×œ×¤×œ ×›×ª×•×'],
  '×—×¡×”': ['×—×¡×”'],
  '×’×–×¨': ['×’×–×¨'],
  '×‘×¦×œ ×™×‘×©': ['×‘×¦×œ ×™×‘×©'],
  '×‘×¦×œ ×™×¨×•×§': ['×‘×¦×œ ×™×¨×•×§'],
  '×ª×¤×•×— ××“××”': ['×ª×¤×•×— ××“××”', '×ª×¤×•"×'],
  '×—×¦×™×œ': ['×—×¦×™×œ', '×—×¦×™×œ×™×'],
  '×§×™×©×•×': ['×–×•×§×™× ×™', '×§×™×©×•××™×'],
  '×›×¨×•×‘×™×ª': ['×›×¨×•×‘×™×ª'],
  '×‘×¨×•×§×•×œ×™': ['×‘×¨×•×§×•×œ×™'],
  '×‘×˜×˜×”': ['×‘×˜×˜×•×ª'],
  '×›×¨×•×‘': ['×›×¨×•×‘ ×œ×‘×Ÿ'],
  '×›×¨×•×‘ ××“×•×': ['×›×¨×•×‘ ××“×•×'],
  '×©×¢×•×¢×™×ª': ['×©×¢×•×¢×™×ª'],
  '×ª×™×¨×¡': ['×ª×™×¨×¡'],
  '××‘×˜×™×—': ['××‘×˜×™×—'],
  '×“×œ×¢×ª': ['×“×œ×¢×ª'],
  '×©×•×': ['×©×•×'],
  '×¡×œ×§': ['×¡×œ×§'],
  '××œ×•×Ÿ': ['××œ×•×Ÿ'],
};

async function fetchWholesalePrices() {
  const url = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://plants.moonsite.co.il');
  const res = await fetch(url);
  const data = await res.json();
  const html = data.contents;

  // Parse the HTML text content for price rows
  // The page contains rows with: date | product name | ×¡×•×’ × price | ××•×‘×—×¨ price
  const prices = {};

  // Extract text between table-like patterns
  // Look for patterns: product name followed by numbers (prices)
  const lines = html.replace(/<[^>]+>/g, '\n').split('\n').map(l => l.trim()).filter(l => l);

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    // Check if this line matches a known wholesale product
    for (const [storeName, keywords] of Object.entries(WHOLESALE_MAP)) {
      for (const keyword of keywords) {
        if (line.includes(keyword) && !prices[storeName]) {
          // Look for price numbers nearby (next few lines)
          const nearby = lines.slice(i, i + 8).join(' ');
          // Extract numbers that look like prices (1-3 digits, optional decimal)
          const priceMatches = nearby.match(/(\d{1,3}\.\d{2})/g);
          if (priceMatches && priceMatches.length >= 1) {
            // If 2 prices found: first is ×¡×•×’ ×, second is ××•×‘×—×¨
            // Priority: ××•×‘×—×¨ first, fallback to ×¡×•×’ ×
            if (priceMatches.length >= 2) {
              prices[storeName] = parseFloat(priceMatches[1]); // ××•×‘×—×¨
            } else {
              prices[storeName] = parseFloat(priceMatches[0]); // ×¡×•×’ ×
            }
          }
        }
      }
    }
  }
  return prices;
}

async function applyWholesalePrices(products, setProducts, setEditPrices, dbConnected) {
  const wholesale = await fetchWholesalePrices();
  const updated = {};
  let count = 0;

  products.forEach(p => {
    if (wholesale[p.name]) {
      updated[p.id] = wholesale[p.name];
      count++;
    }
  });

  if (count > 0) {
    // Update edit prices in PricingPage
    if (setEditPrices) {
      setEditPrices(prev => ({ ...prev, ...updated }));
    }

    // Update products state
    setProducts(prev => prev.map(p => updated[p.id] ? { ...p, price: updated[p.id] } : p));

    // Save to Supabase via RPC function (bypasses RLS)
    if (sb && dbConnected) {
      for (const [productId, price] of Object.entries(updated)) {
        await sb.rpc('upsert_daily_price', { p_product_id: productId, p_price: price, p_available: true });
      }
    }
  }

  return { count, prices: wholesale };
}

// ==================== MAIN APP ====================
function AdminApp() {
  const [loggedIn, setLoggedIn] = useState(false);
  const [user, setUser] = useState(null);
  const [page, setPage] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [orders, setOrders] = useState(INITIAL_ORDERS);
  const [products, setProducts] = useState(INITIAL_PRODUCTS);
  const [dbConnected, setDbConnected] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const [wholesaleStatus, setWholesaleStatus] = useState({ lastFetch: null, count: 0, loading: false, error: '' });
  const knownOrderIdsRef = React.useRef(null);
  const settingsRef = React.useRef(null);
  const wholesaleFetchedTodayRef = React.useRef(false);
  const [settings, setSettings] = useState({
    orderingOpen: true,
    orderingStartHour: '07:00',
    orderingEndHour: '20:00',
    deliveryFee: 15,
    minOrderAmount: 50,
    deliveryEnabled: true,
    pickupEnabled: true,
    name: '×‘×¨×›×ª ×”×©×“×”',
    address: '×¨×—×•×‘ ×”×¨×¦×œ 12, ×‘×™×ª ×©××©',
    phone: '02-999-8888',
    deliveryArea: '×‘×™×ª ×©××© ×‘×œ×‘×“',
    // Notification settings
    emailjsEnabled: false,
    emailjsServiceId: '',
    emailjsTemplateId: '',
    emailjsPublicKey: '',
    emailjsToEmail: 'shaked4561@gmail.com',
    whatsappEnabled: false,
    whatsappPhone: '972542556706',
    twilioAccountSid: '',
    twilioAuthToken: '',
    twilioWhatsappFrom: '',
    // Customer WhatsApp Business settings
    customerWhatsappEnabled: false,
    whatsappBusinessPhoneId: '',
    whatsappBusinessToken: '',
    // Delivery time slots
    deliveryTimeSlots: '08:00-10:00,10:00-12:00,12:00-14:00,14:00-16:00,16:00-18:00,18:00-20:00',
  });

  // Keep settings ref in sync for use inside loadFromDB closure
  useEffect(() => { settingsRef.current = settings; }, [settings]);

  // Load data from Supabase
  async function loadFromDB() {
    if (!sb) return;
    try {
      // Load orders with items
      const { data: dbOrders, error: ordErr } = await sb
        .from('orders')
        .select('*')
        .order('created_at', { ascending: false });
      if (ordErr) throw ordErr;

      // Load order items for each order
      const orderIds = dbOrders.map(o => o.id);
      const { data: dbItems } = await sb
        .from('order_items')
        .select('*')
        .in('order_id', orderIds);

      const itemsByOrder = {};
      if (dbItems) dbItems.forEach(i => {
        if (!itemsByOrder[i.order_id]) itemsByOrder[i.order_id] = [];
        itemsByOrder[i.order_id].push({ itemId: i.id, name: i.product_name_he, qty: parseFloat(i.quantity), unit: i.unit_type, price: parseFloat(i.price_at_purchase), actualQty: i.actual_quantity != null ? parseFloat(i.actual_quantity) : null });
      });

      const mappedOrders = dbOrders.map(o => ({
        id: o.id,
        orderNumber: o.order_number,
        customerName: o.customer_name,
        phone: o.customer_phone,
        email: o.customer_email || '',
        deliveryType: o.delivery_type,
        address: o.delivery_address || '',
        timeSlot: o.delivery_time_slot || '',
        items: itemsByOrder[o.id] || [],
        total: parseFloat(o.total_amount),
        status: o.status,
        paymentStatus: o.payment_status,
        notes: o.notes || '',
        createdAt: new Date(o.created_at),
      }));

      // Detect new orders
      if (knownOrderIdsRef.current !== null) {
        const newOrders = mappedOrders.filter(o => !knownOrderIdsRef.current.has(o.id));
        if (newOrders.length > 0) {
          playNotificationSound();
          const currentSettings = settingsRef.current;
          newOrders.forEach(o => {
            const notif = { id: Date.now() + '-' + o.id, orderNumber: o.orderNumber, customerName: o.customerName, total: o.total };
            setNotifications(prev => [...prev, notif]);
            setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== notif.id)), 6000);
            // Browser notification
            if (Notification.permission === 'granted') {
              new Notification('×”×–×× ×” ×—×“×©×”!', { body: `#${o.orderNumber} - ${o.customerName} | ${o.total.toFixed(2)}â‚ª`, icon: 'ğŸ›’' });
            }
            // Email notification (WhatsApp handled by DB trigger via pg_net)
            sendEmailNotification(o, currentSettings);
          });
        }
      }
      knownOrderIdsRef.current = new Set(mappedOrders.map(o => o.id));

      setOrders(mappedOrders);

      // Load products
      const { data: dbProds } = await sb.from('products').select('*').order('sort_order');
      if (dbProds) {
        const mappedProds = dbProds.map(p => ({
          id: p.id, name: p.name_he, category: p.category, unit: p.unit,
          price: 0, active: p.is_active, image: p.image_emoji || 'ğŸ', imageUrl: p.image_url || null,
        }));

        // Load today prices
        const today = new Date().toISOString().split('T')[0];
        const { data: todayPrices } = await sb.from('daily_prices').select('*').eq('date', today);
        const todayPriceMap = {};
        if (todayPrices) {
          todayPrices.forEach(p => { todayPriceMap[p.product_id] = parseFloat(p.price_nis); });
          mappedProds.forEach(p => { if (todayPriceMap[p.id]) p.price = todayPriceMap[p.id]; });
        }

        // For products without today's price, fetch most recent price
        const missingIds = mappedProds.filter(p => !todayPriceMap[p.id]).map(p => p.id);
        if (missingIds.length > 0) {
          const { data: latestPrices } = await sb.from('daily_prices').select('*').in('product_id', missingIds).eq('stock_available', true).order('date', { ascending: false });
          if (latestPrices) {
            const latestMap = {};
            latestPrices.forEach(p => { if (!latestMap[p.product_id]) latestMap[p.product_id] = parseFloat(p.price_nis); });
            mappedProds.forEach(p => { if (!todayPriceMap[p.id] && latestMap[p.id]) p.price = latestMap[p.id]; });
          }
        }
        setProducts(mappedProds);
      }

      // Load settings
      const { data: dbSets } = await sb.from('store_settings').select('*');
      if (dbSets && dbSets.length > 0) {
        const sObj = {};
        dbSets.forEach(s => { sObj[s.setting_key] = s.setting_value; });
        setSettings(prev => ({
          ...prev,
          orderingOpen: sObj.ordering_open === 'true',
          orderingStartHour: sObj.ordering_start_hour || '07:00',
          orderingEndHour: sObj.ordering_end_hour || '20:00',
          deliveryFee: parseFloat(sObj.delivery_fee) || 15,
          minOrderAmount: parseFloat(sObj.min_order_amount) || 50,
          deliveryEnabled: sObj.delivery_enabled === 'true',
          pickupEnabled: sObj.pickup_enabled === 'true',
          name: sObj.store_name || '×‘×¨×›×ª ×”×©×“×”',
          address: sObj.store_address || '',
          phone: sObj.store_phone || '',
          deliveryArea: sObj.delivery_area || '',
          // Notification settings from DB
          emailjsEnabled: sObj.emailjs_enabled === 'true' || prev.emailjsEnabled,
          emailjsServiceId: sObj.emailjs_service_id || prev.emailjsServiceId,
          emailjsTemplateId: sObj.emailjs_template_id || prev.emailjsTemplateId,
          emailjsPublicKey: sObj.emailjs_public_key || prev.emailjsPublicKey,
          emailjsToEmail: sObj.emailjs_to_email || prev.emailjsToEmail,
          whatsappEnabled: sObj.whatsapp_enabled === 'true' || prev.whatsappEnabled,
          whatsappPhone: sObj.whatsapp_phone || prev.whatsappPhone,
          twilioAccountSid: sObj.twilio_account_sid || prev.twilioAccountSid,
          twilioAuthToken: sObj.twilio_auth_token || prev.twilioAuthToken,
          twilioWhatsappFrom: sObj.twilio_whatsapp_from || prev.twilioWhatsappFrom,
          customerWhatsappEnabled: sObj.customer_whatsapp_enabled === 'true' || prev.customerWhatsappEnabled,
          whatsappBusinessPhoneId: sObj.whatsapp_business_phone_id || prev.whatsappBusinessPhoneId,
          whatsappBusinessToken: sObj.whatsapp_business_token || prev.whatsappBusinessToken,
          deliveryTimeSlots: sObj.delivery_time_slots || prev.deliveryTimeSlots,
        }));
      }
      setDbConnected(true);
    } catch (err) {
      console.log('DB not ready, using mock data:', err.message);
    }
  }

  useEffect(() => { if (loggedIn) loadFromDB(); }, [loggedIn]);

  // Auto-refresh orders every 15 seconds
  useEffect(() => {
    if (!loggedIn || !dbConnected) return;
    const interval = setInterval(loadFromDB, 15000);
    return () => clearInterval(interval);
  }, [loggedIn, dbConnected]);

  // Wholesale price fetch wrapper
  const triggerWholesaleFetch = useCallback(async () => {
    setWholesaleStatus(prev => ({ ...prev, loading: true, error: '' }));
    try {
      const result = await applyWholesalePrices(products, setProducts, null, dbConnected);
      setWholesaleStatus({ lastFetch: new Date(), count: result.count, loading: false, error: '' });
      wholesaleFetchedTodayRef.current = true;
      console.log(`Wholesale prices updated: ${result.count} products`);
    } catch (err) {
      console.error('Wholesale fetch failed:', err);
      setWholesaleStatus(prev => ({ ...prev, loading: false, error: '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××—×™×¨×™× ×¡×™×˜×•× ××™×™×' }));
    }
  }, [products, dbConnected]);

  // Auto-fetch wholesale prices at 7:30 AM daily
  useEffect(() => {
    if (!loggedIn) return;
    const checkSchedule = () => {
      const now = new Date();
      const hour = now.getHours();
      const minute = now.getMinutes();
      if (hour === 7 && minute >= 30 && minute <= 32 && !wholesaleFetchedTodayRef.current) {
        triggerWholesaleFetch();
      }
      // Reset flag at midnight
      if (hour === 0 && minute === 0) {
        wholesaleFetchedTodayRef.current = false;
      }
    };
    // Also try fetching on load if after 7:30 and not yet fetched today
    const now = new Date();
    if ((now.getHours() > 7 || (now.getHours() === 7 && now.getMinutes() >= 30)) && !wholesaleFetchedTodayRef.current) {
      triggerWholesaleFetch();
    }
    const interval = setInterval(checkSchedule, 60000); // check every minute
    return () => clearInterval(interval);
  }, [loggedIn, triggerWholesaleFetch]);

  const handleLogin = (userData) => {
    setUser(userData);
    setLoggedIn(true);
    // Request browser notification permission
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  };

  // Update order status in Supabase
  const setOrdersWithDB = async (updater) => {
    setOrders(updater);
    // The OrdersPage calls setOrders with a function - we intercept and also update DB
  };

  // Wrapper to update order status in DB
  const updateOrderStatusDB = async (orderId, newStatus) => {
    const order = orders.find(o => o.id === orderId);
    setOrders(prev => prev.map(o => o.id === orderId ? { ...o, status: newStatus } : o));
    if (sb && dbConnected) {
      await sb.from('orders').update({ status: newStatus }).eq('id', orderId);
    }
    // Send WhatsApp status update to customer (fire-and-forget)
    if (order) {
      sendCustomerStatusWhatsApp(order, newStatus, settingsRef.current);
    }
  };

  if (!loggedIn) return <LoginPage onLogin={handleLogin} />;

  const PAGE_TITLES = { dashboard: '×“×©×‘×•×¨×“', orders: '×”×–×× ×•×ª', pricing: '××—×™×¨×™×', products: '××•×¦×¨×™×', settings: '×”×’×“×¨×•×ª' };

  return (
    <div className="flex">
      {/* New order notifications */}
      {notifications.map(n => (
        <div key={n.id} className="notification-toast bg-green-600 text-white rounded-xl shadow-lg px-6 py-4 flex items-center gap-3" onClick={() => { setPage('orders'); setNotifications(prev => prev.filter(x => x.id !== n.id)); }}>
          <span className="text-2xl">ğŸ›’</span>
          <div>
            <div className="font-bold">×”×–×× ×” ×—×“×©×”!</div>
            <div className="text-sm">#{n.orderNumber} - {n.customerName} | {n.total.toFixed(2)}â‚ª</div>
          </div>
          <button onClick={(e) => { e.stopPropagation(); setNotifications(prev => prev.filter(x => x.id !== n.id)); }} className="mr-2 text-white text-xl leading-none hover:opacity-70">&times;</button>
        </div>
      ))}

      {/* Mobile top bar */}
      <div className="mobile-topbar">
        <button onClick={() => setSidebarOpen(true)} className="text-2xl leading-none p-1">â˜°</button>
        <span className="font-bold text-lg">{PAGE_TITLES[page]}</span>
      </div>

      <Sidebar activePage={page} setPage={setPage} user={user} onLogout={() => setLoggedIn(false)} isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} />
      <main className="main-content flex-1 p-4 sm:p-6 min-h-screen" style={{ marginRight: '256px' }}>
        {!dbConnected && (
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-yellow-800 text-sm">
            âš ï¸ ×œ× ××—×•×‘×¨ ×œ-Supabase - ××¦×™×’ × ×ª×•× ×™ ×“××•. ×”×¨×¥ ××ª ×§×‘×¦×™ ×”-SQL ×›×“×™ ×œ×—×‘×¨ ×œ×‘×¡×™×¡ ×”× ×ª×•× ×™×.
          </div>
        )}
        {dbConnected && (
          <div className="bg-green-50 border border-green-200 rounded-lg p-2 mb-4 text-green-800 text-xs flex items-center justify-between">
            <span>âœ… ××—×•×‘×¨ ×œ-Supabase | ××ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ×›×œ 15 ×©× ×™×•×ª</span>
            <button onClick={loadFromDB} className="text-green-700 font-bold hover:underline">ğŸ”„ ×¨×¢× ×Ÿ ×¢×›×©×™×•</button>
          </div>
        )}
        {page === 'dashboard' && <DashboardPage orders={orders} settings={settings} />}
        {page === 'orders' && <OrdersPage orders={orders} setOrders={setOrders} updateStatusDB={updateOrderStatusDB} dbConnected={dbConnected} />}
        {page === 'pricing' && <PricingPage products={products} setProducts={setProducts} dbConnected={dbConnected} wholesaleStatus={wholesaleStatus} onFetchWholesale={triggerWholesaleFetch} />}
        {page === 'products' && <ProductsPage products={products} setProducts={setProducts} dbConnected={dbConnected} />}
        {page === 'settings' && <SettingsPage settings={settings} setSettings={setSettings} dbConnected={dbConnected} />}
      </main>
    </div>
  );
}

ReactDOM.render(<AdminApp />, document.getElementById('root'));
</script>
</body>
</html>
