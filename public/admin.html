<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×‘×¨×›×ª ×”×©×“×” - ×¤×× ×œ × ×™×”×•×œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/shared.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans Hebrew', sans-serif; }
    body { direction: rtl; background: #f3f4f6; }
    .sidebar-link { transition: all 0.2s; }
    .sidebar-link:hover, .sidebar-link.active { background: rgba(255,255,255,0.15); }
    .stat-card { transition: all 0.3s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; white-space: nowrap; }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #4a7c23; box-shadow: 0 0 0 3px rgba(74,124,35,0.1); }
    .toggle-switch { position: relative; width: 56px; height: 28px; background: #d1d5db; border-radius: 14px; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
    .toggle-switch.active { background: #4a7c23; }
    .toggle-switch::after { content: ''; position: absolute; top: 2px; right: 2px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle-switch.active::after { right: 30px; }
    .order-row:hover { background: #f9fafb; }
    .price-input { width: 100px; }
    /* Mobile sidebar overlay */
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
    .sidebar-overlay.active { display: block; }
    /* Notification toast */
    .notification-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; animation: slideDown 0.4s ease, fadeOut 0.4s ease 5.6s forwards; max-width: 90vw; }
    @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    /* Mobile top bar */
    .mobile-topbar { display: none; }
    @media (max-width: 768px) {
      .mobile-topbar { display: flex; position: fixed; top: 0; right: 0; left: 0; height: 56px; background: #276749; color: white; align-items: center; padding: 0 16px; z-index: 30; gap: 12px; }
      .desktop-sidebar { transform: translateX(100%); transition: transform 0.3s ease; z-index: 50; }
      .desktop-sidebar.open { transform: translateX(0); }
      .main-content { margin-right: 0 !important; padding-top: 72px !important; }
    }
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

// Shared globals from js/shared.js: supabaseClient, SUPABASE_URL, SUPABASE_KEY, PRODUCT_IMAGES, getProductImage, CATEGORIES, CATEGORY_MAP
const sb = supabaseClient;

// ==================== MOCK DATA (fallback) ====================
const INITIAL_PRODUCTS = [
  { id: 1, name: '×ª×¤×•×—×™× ×—×¨××•×Ÿ', category: 'fruits', unit: 'kg', price: 12.90, active: true, image: 'ğŸ' },
  { id: 2, name: '×‘× × ×•×ª', category: 'fruits', unit: 'kg', price: 9.90, active: true, image: 'ğŸŒ' },
  { id: 3, name: '×¢× ×‘×™× ×™×¨×•×§×™×', category: 'fruits', unit: 'kg', price: 19.90, active: true, image: 'ğŸ‡' },
  { id: 4, name: '××‘×˜×™×—', category: 'fruits', unit: 'kg', price: 4.90, active: true, image: 'ğŸ‰' },
  { id: 5, name: '××’×¡×™×', category: 'fruits', unit: 'kg', price: 14.90, active: true, image: 'ğŸ' },
  { id: 6, name: '× ×§×˜×¨×™× ×•×ª', category: 'fruits', unit: 'kg', price: 15.90, active: true, image: 'ğŸ‘' },
  { id: 7, name: '×ª×•×ª×™×', category: 'fruits', unit: 'unit', price: 14.90, active: true, image: 'ğŸ“' },
  { id: 8, name: '×¨×™××•× ×™×', category: 'fruits', unit: 'kg', price: 12.90, active: true, image: 'ğŸ' },
  { id: 11, name: '×¢×’×‘× ×™×•×ª', category: 'vegetables', unit: 'kg', price: 6.90, active: true, image: 'ğŸ…' },
  { id: 12, name: '××œ×¤×¤×•× ×™×', category: 'vegetables', unit: 'kg', price: 5.90, active: true, image: 'ğŸ¥’' },
  { id: 13, name: '×¤×œ×¤×œ ××“×•×', category: 'vegetables', unit: 'kg', price: 11.90, active: true, image: 'ğŸ«‘' },
  { id: 14, name: '×¤×œ×¤×œ ×™×¨×•×§', category: 'vegetables', unit: 'kg', price: 7.90, active: true, image: 'ğŸ«‘' },
  { id: 15, name: '×—×¡×”', category: 'vegetables', unit: 'unit', price: 5.90, active: true, image: 'ğŸ¥¬' },
  { id: 16, name: '×’×–×¨', category: 'vegetables', unit: 'kg', price: 4.90, active: true, image: 'ğŸ¥•' },
  { id: 17, name: '×‘×¦×œ ×™×‘×©', category: 'vegetables', unit: 'kg', price: 4.90, active: true, image: 'ğŸ§…' },
  { id: 18, name: '×ª×¤×•×— ××“××”', category: 'vegetables', unit: 'kg', price: 5.90, active: true, image: 'ğŸ¥”' },
  { id: 19, name: '×—×¦×™×œ', category: 'vegetables', unit: 'kg', price: 7.90, active: true, image: 'ğŸ†' },
  { id: 20, name: '×§×™×©×•×', category: 'vegetables', unit: 'kg', price: 6.90, active: true, image: 'ğŸ¥’' },
  { id: 26, name: '×¤×˜×¨×•×–×™×œ×™×”', category: 'herbs', unit: 'unit', price: 3.90, active: true, image: 'ğŸŒ¿' },
  { id: 27, name: '×›×•×¡×‘×¨×”', category: 'herbs', unit: 'unit', price: 3.90, active: true, image: 'ğŸŒ¿' },
  { id: 28, name: '× ×¢× ×¢', category: 'herbs', unit: 'unit', price: 3.90, active: true, image: 'ğŸŒ¿' },
  { id: 32, name: '×ª×¤×•×–×™×', category: 'citrus', unit: 'kg', price: 6.90, active: true, image: 'ğŸŠ' },
  { id: 33, name: '×œ×™××•×Ÿ', category: 'citrus', unit: 'kg', price: 7.90, active: true, image: 'ğŸ‹' },
  { id: 37, name: '×× ×’×•', category: 'exotic', unit: 'kg', price: 24.90, active: true, image: 'ğŸ¥­' },
  { id: 38, name: '××‘×•×§×“×•', category: 'exotic', unit: 'kg', price: 19.90, active: true, image: 'ğŸ¥‘' },
];

const INITIAL_ORDERS = [
  {
    id: 1001, orderNumber: 4521, customerName: '×™×•×¡×™ ×›×”×Ÿ', phone: '050-1234567', email: 'yossi@email.com',
    deliveryType: 'delivery', address: '×¨×—×•×‘ ×”×“×§×œ 5, ×‘×™×ª ×©××©',
    items: [
      { name: '×¢×’×‘× ×™×•×ª', qty: 2, unit: 'kg', price: 6.90 },
      { name: '××œ×¤×¤×•× ×™×', qty: 1.5, unit: 'kg', price: 5.90 },
      { name: '×¤×œ×¤×œ ××“×•×', qty: 1, unit: 'kg', price: 11.90 },
      { name: '×‘× × ×•×ª', qty: 1, unit: 'kg', price: 9.90 },
    ],
    total: 44.55, status: 'pending', paymentStatus: 'paid', notes: '', createdAt: new Date(Date.now() - 1000*60*15),
  },
  {
    id: 1002, orderNumber: 4522, customerName: '×©×¨×” ×œ×•×™', phone: '052-9876543', email: '',
    deliveryType: 'pickup', address: '',
    items: [
      { name: '×ª×¤×•×—×™× ×—×¨××•×Ÿ', qty: 3, unit: 'kg', price: 12.90 },
      { name: '×‘× × ×•×ª', qty: 2, unit: 'kg', price: 9.90 },
      { name: '×—×¡×”', qty: 2, unit: 'unit', price: 5.90 },
      { name: '×¤×˜×¨×•×–×™×œ×™×”', qty: 1, unit: 'unit', price: 3.90 },
      { name: '× ×¢× ×¢', qty: 1, unit: 'unit', price: 3.90 },
    ],
    total: 77.30, status: 'confirmed', paymentStatus: 'paid', notes: '×× ×™ ×¦×¨×™×›×” ××ª ×–×” ×¢×“ 14:00', createdAt: new Date(Date.now() - 1000*60*45),
  },
  {
    id: 1003, orderNumber: 4523, customerName: '×“×•×“ ×™×©×¨××œ×™', phone: '054-5555555', email: 'david@mail.com',
    deliveryType: 'delivery', address: '×¨×—×•×‘ ×”×¨×¦×œ 28, ×‘×™×ª ×©××©',
    items: [
      { name: '×× ×’×•', qty: 2, unit: 'kg', price: 24.90 },
      { name: '××‘×•×§×“×•', qty: 1.5, unit: 'kg', price: 19.90 },
      { name: '×œ×™××•×Ÿ', qty: 1, unit: 'kg', price: 7.90 },
    ],
    total: 87.55, status: 'ready', paymentStatus: 'paid', notes: '', createdAt: new Date(Date.now() - 1000*60*120),
  },
  {
    id: 1004, orderNumber: 4524, customerName: '×¨×—×œ ××–×¨×—×™', phone: '058-7777777', email: '',
    deliveryType: 'pickup', address: '',
    items: [
      { name: '×¢×’×‘× ×™×•×ª', qty: 3, unit: 'kg', price: 6.90 },
      { name: '××œ×¤×¤×•× ×™×', qty: 2, unit: 'kg', price: 5.90 },
      { name: '×’×–×¨', qty: 1, unit: 'kg', price: 4.90 },
      { name: '×‘×¦×œ ×™×‘×©', qty: 2, unit: 'kg', price: 4.90 },
      { name: '×ª×¤×•×— ××“××”', qty: 3, unit: 'kg', price: 5.90 },
    ],
    total: 68.20, status: 'completed', paymentStatus: 'paid', notes: '', createdAt: new Date(Date.now() - 1000*60*240),
  },
  {
    id: 1005, orderNumber: 4525, customerName: '××‘×¨×”× ×’×•×œ×“', phone: '053-1111111', email: 'avi@test.com',
    deliveryType: 'delivery', address: '×©×“\' ×‘×Ÿ ×’×•×¨×™×•×Ÿ 14, ×‘×™×ª ×©××©',
    items: [
      { name: '×ª×¤×•×–×™×', qty: 5, unit: 'kg', price: 6.90 },
      { name: '×ª×¤×•×—×™× ×—×¨××•×Ÿ', qty: 2, unit: 'kg', price: 12.90 },
      { name: '×¢× ×‘×™× ×™×¨×•×§×™×', qty: 1, unit: 'kg', price: 19.90 },
    ],
    total: 80.20, status: 'pending', paymentStatus: 'paid', notes: '×‘×‘×§×©×” ×œ×”×ª×§×©×¨ ×œ×¤× ×™', createdAt: new Date(Date.now() - 1000*60*5),
  },
];

const STATUS_MAP = {
  pending: { label: '×××ª×™×Ÿ', color: 'bg-yellow-100 text-yellow-800', icon: 'â³' },
  confirmed: { label: '××•×©×¨', color: 'bg-blue-100 text-blue-800', icon: 'âœ“' },
  ready: { label: '××•×›×Ÿ', color: 'bg-purple-100 text-purple-800', icon: 'ğŸ“¦' },
  completed: { label: '×”×•×©×œ×', color: 'bg-green-100 text-green-800', icon: 'âœ…' },
  cancelled: { label: '×‘×•×˜×œ', color: 'bg-red-100 text-red-800', icon: 'âŒ' },
};

// CATEGORY_MAP loaded from js/shared.js

// ==================== LOGIN ====================
function LoginPage({ onLogin }) {
  const [email, setEmail] = useState('admin@birkat.co.il');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleLogin = (e) => {
    e.preventDefault();
    if (!email || !password) {
      setError('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
    } else if (password !== 'yoni123') {
      setError('×¡×™×¡××” ×©×’×•×™×”');
    } else {
      onLogin({ email, name: '×× ×”×œ ×¨××©×™' });
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-green-800 to-green-900 p-4">
      <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
        <div className="text-center mb-8">
          <div className="w-16 h-16 bg-green-700 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-3">×‘</div>
          <h1 className="text-2xl font-bold text-gray-800">×‘×¨×›×ª ×”×©×“×”</h1>
          <p className="text-gray-500">×¤×× ×œ × ×™×”×•×œ</p>
        </div>
        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">××™××™×™×œ</label>
            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-200" dir="ltr" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">×¡×™×¡××”</label>
            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 rounded-lg border border-gray-200" placeholder="×”×›× ×¡ ×¡×™×¡××”" />
          </div>
          {error && <p className="text-red-500 text-sm">{error}</p>}
          <button type="submit" className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">
            ×”×ª×—×‘×¨
          </button>
        </form>
        <p className="text-xs text-gray-400 text-center mt-4">×¤×× ×œ × ×™×”×•×œ - ×”×›× ×¡ ×¡×™×¡××” ×œ×›× ×™×¡×”</p>
      </div>
    </div>
  );
}

// ==================== SIDEBAR ====================
function Sidebar({ activePage, setPage, user, onLogout, isOpen, onClose }) {
  const links = [
    { id: 'dashboard', label: '×“×©×‘×•×¨×“', icon: 'ğŸ“Š' },
    { id: 'orders', label: '×”×–×× ×•×ª', icon: 'ğŸ“‹' },
    { id: 'pricing', label: '××—×™×¨×™×', icon: 'ğŸ’°' },
    { id: 'products', label: '××•×¦×¨×™×', icon: 'ğŸ“¦' },
    { id: 'settings', label: '×”×’×“×¨×•×ª', icon: 'âš™ï¸' },
  ];

  const handlePageClick = (id) => {
    setPage(id);
    if (onClose) onClose();
  };

  return (
    <>
      <div className={`sidebar-overlay ${isOpen ? 'active' : ''}`} onClick={onClose}></div>
      <aside className={`desktop-sidebar w-64 bg-green-800 text-white min-h-screen fixed right-0 top-0 flex flex-col ${isOpen ? 'open' : ''}`}>
        <div className="p-6 border-b border-green-700">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center font-bold">×‘</div>
            <div>
              <h2 className="font-bold">×‘×¨×›×ª ×”×©×“×”</h2>
              <p className="text-xs text-green-300">×¤×× ×œ × ×™×”×•×œ</p>
            </div>
          </div>
        </div>

        <nav className="flex-1 py-4">
          {links.map(link => (
            <button
              key={link.id}
              onClick={() => handlePageClick(link.id)}
              className={`sidebar-link w-full text-right px-6 py-3 flex items-center gap-3 ${activePage === link.id ? 'active bg-green-700' : ''}`}
            >
              <span>{link.icon}</span>
              <span className="font-medium">{link.label}</span>
            </button>
          ))}
        </nav>

        <div className="p-4 border-t border-green-700">
          <div className="text-sm mb-2">ğŸ‘¤ {user.name}</div>
          <div className="flex gap-2">
            <a href="index.html" className="text-xs text-green-300 hover:text-white">×¦×¤×” ×‘××ª×¨ â†’</a>
            <button onClick={onLogout} className="text-xs text-red-300 hover:text-red-100 mr-auto">×”×ª× ×ª×§</button>
          </div>
        </div>
      </aside>
    </>
  );
}

// ==================== DASHBOARD ====================
function DashboardPage({ orders, settings }) {
  const today = new Date().toLocaleDateString('he-IL');
  const todayOrders = orders.filter(o => o.status !== 'cancelled');
  const pendingOrders = orders.filter(o => o.status === 'pending');
  const totalRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
  const completedOrders = orders.filter(o => o.status === 'completed');

  return (
    <div className="fade-in">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-2">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">×“×©×‘×•×¨×“</h1>
          <p className="text-gray-500 text-sm">{today}</p>
        </div>
        <div className={`px-4 py-2 rounded-full text-sm font-bold ${settings.orderingOpen ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
          {settings.orderingOpen ? 'âœ… ×”×–×× ×•×ª ×¤×ª×•×—×•×ª' : 'âŒ ×”×–×× ×•×ª ×¡×’×•×¨×•×ª'}
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div className="stat-card bg-white rounded-xl p-5 shadow-sm">
          <div className="text-3xl mb-1">ğŸ“‹</div>
          <div className="text-3xl font-bold text-gray-800">{todayOrders.length}</div>
          <div className="text-sm text-gray-500">×”×–×× ×•×ª ×”×™×•×</div>
        </div>
        <div className="stat-card bg-white rounded-xl p-5 shadow-sm">
          <div className="text-3xl mb-1">â³</div>
          <div className="text-3xl font-bold text-yellow-600">{pendingOrders.length}</div>
          <div className="text-sm text-gray-500">×××ª×™× ×•×ª ×œ××™×©×•×¨</div>
        </div>
        <div className="stat-card bg-white rounded-xl p-5 shadow-sm">
          <div className="text-3xl mb-1">ğŸ’°</div>
          <div className="text-3xl font-bold text-green-700">{totalRevenue.toFixed(0)}â‚ª</div>
          <div className="text-sm text-gray-500">×”×›× ×¡×•×ª ×”×™×•×</div>
        </div>
        <div className="stat-card bg-white rounded-xl p-5 shadow-sm">
          <div className="text-3xl mb-1">âœ…</div>
          <div className="text-3xl font-bold text-blue-600">{completedOrders.length}</div>
          <div className="text-sm text-gray-500">×”×–×× ×•×ª ×©×”×•×©×œ××•</div>
        </div>
      </div>

      {/* Pending orders alert */}
      {pendingOrders.length > 0 && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
          <div className="font-bold text-yellow-800 mb-2">âš ï¸ {pendingOrders.length} ×”×–×× ×•×ª ×××ª×™× ×•×ª ×œ××™×©×•×¨!</div>
          {pendingOrders.map(o => (
            <div key={o.id} className="text-sm text-yellow-700 py-1">
              #{o.orderNumber} - {o.customerName} | {o.total.toFixed(2)}â‚ª | {o.deliveryType === 'delivery' ? 'ğŸš— ××©×œ×•×—' : 'ğŸ“ ××™×¡×•×£'} | {timeAgo(o.createdAt)}
            </div>
          ))}
        </div>
      )}

      {/* Recent orders */}
      <div className="bg-white rounded-xl shadow-sm">
        <div className="p-4 border-b">
          <h3 className="font-bold text-gray-800">×”×–×× ×•×ª ××—×¨×•× ×•×ª</h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="py-3 px-4 text-right font-medium text-gray-600">××¡×³</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×œ×§×•×—</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×•×’</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×›×•×</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×˜×˜×•×¡</th>
                <th className="py-3 px-4 text-right font-medium text-gray-600">×–××Ÿ</th>
              </tr>
            </thead>
            <tbody>
              {orders.slice(0, 10).map(o => (
                <tr key={o.id} className="order-row border-b">
                  <td className="py-3 px-4 font-bold">#{o.orderNumber}</td>
                  <td className="py-3 px-4">{o.customerName}</td>
                  <td className="py-3 px-4">{o.deliveryType === 'delivery' ? 'ğŸš—' : 'ğŸ“'}</td>
                  <td className="py-3 px-4 font-medium">{o.total.toFixed(2)}â‚ª</td>
                  <td className="py-3 px-4">
                    <span className={`status-badge ${STATUS_MAP[o.status].color}`}>
                      {STATUS_MAP[o.status].icon} {STATUS_MAP[o.status].label}
                    </span>
                  </td>
                  <td className="py-3 px-4 text-gray-500">{timeAgo(o.createdAt)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

function timeAgo(date) {
  const now = new Date();
  const diff = Math.floor((now - date) / 1000 / 60);
  if (diff < 1) return '×¢×›×©×™×•';
  if (diff < 60) return `×œ×¤× ×™ ${diff} ×“×§×³`;
  if (diff < 1440) return `×œ×¤× ×™ ${Math.floor(diff/60)} ×©×¢×•×ª`;
  return date.toLocaleDateString('he-IL');
}

// ==================== ORDERS PAGE ====================
function OrdersPage({ orders, setOrders, updateStatusDB, dbConnected }) {
  const [filter, setFilter] = useState('all');
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [search, setSearch] = useState('');

  const filtered = useMemo(() => {
    return orders.filter(o => {
      const matchStatus = filter === 'all' || o.status === filter;
      const matchSearch = !search || o.customerName.includes(search) || String(o.orderNumber).includes(search) || o.phone.includes(search);
      return matchStatus && matchSearch;
    });
  }, [orders, filter, search]);

  const updateStatus = (orderId, newStatus) => {
    if (updateStatusDB) {
      updateStatusDB(orderId, newStatus);
    } else {
      setOrders(prev => prev.map(o => o.id === orderId ? { ...o, status: newStatus } : o));
    }
    if (selectedOrder && selectedOrder.id === orderId) {
      setSelectedOrder(prev => ({ ...prev, status: newStatus }));
    }
  };

  if (selectedOrder) {
    return (
      <div className="fade-in">
        <button onClick={() => setSelectedOrder(null)} className="text-green-700 font-medium mb-4 hover:underline">â† ×—×–×¨×” ×œ×¨×©×™××”</button>

        <div className="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-4">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <h2 className="text-xl font-bold">×”×–×× ×” #{selectedOrder.orderNumber}</h2>
            <span className={`status-badge ${STATUS_MAP[selectedOrder.status].color}`}>
              {STATUS_MAP[selectedOrder.status].icon} {STATUS_MAP[selectedOrder.status].label}
            </span>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
              <h3 className="font-bold text-gray-700 mb-2">×¤×¨×˜×™ ×œ×§×•×—</h3>
              <p>ğŸ‘¤ {selectedOrder.customerName}</p>
              <p>ğŸ“± <a href={`tel:${selectedOrder.phone}`} className="text-blue-600 underline" dir="ltr">{selectedOrder.phone}</a></p>
              {selectedOrder.email && <p>âœ‰ï¸ {selectedOrder.email}</p>}
            </div>
            <div>
              <h3 className="font-bold text-gray-700 mb-2">×¤×¨×˜×™ ××©×œ×•×—</h3>
              <p>{selectedOrder.deliveryType === 'delivery' ? 'ğŸš— ××©×œ×•×— ×œ: ' + selectedOrder.address : 'ğŸ“ ××™×¡×•×£ ×¢×¦××™'}</p>
              <p>ğŸ• {selectedOrder.createdAt.toLocaleString('he-IL')}</p>
              <p>ğŸ’³ {selectedOrder.paymentStatus === 'paid' ? 'âœ… ×©×•×œ×' : 'âŒ ×œ× ×©×•×œ×'}</p>
            </div>
          </div>

          {selectedOrder.notes && (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
              <span className="font-medium">ğŸ“ ×”×¢×¨×•×ª: </span>{selectedOrder.notes}
            </div>
          )}

          <h3 className="font-bold text-gray-700 mb-2">×¤×¨×™×˜×™×</h3>
          <div className="bg-gray-50 rounded-lg overflow-x-auto mb-4">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b">
                  <th className="py-2 px-4 text-right">××•×¦×¨</th>
                  <th className="py-2 px-4 text-right">×›××•×ª</th>
                  <th className="py-2 px-4 text-right">××—×™×¨</th>
                  <th className="py-2 px-4 text-right">×¡×”"×›</th>
                </tr>
              </thead>
              <tbody>
                {selectedOrder.items.map((item, i) => (
                  <tr key={i} className="border-b">
                    <td className="py-2 px-4">{item.name}</td>
                    <td className="py-2 px-4">{item.qty} {item.unit === 'kg' ? '×§"×’' : '×™×—×³'}</td>
                    <td className="py-2 px-4">{item.price.toFixed(2)}â‚ª</td>
                    <td className="py-2 px-4 font-medium">{(item.price * item.qty).toFixed(2)}â‚ª</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div className="text-left text-xl font-bold text-green-700">
            ×¡×”"×›: {selectedOrder.total.toFixed(2)}â‚ª
          </div>
        </div>

        {/* Actions */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h3 className="font-bold text-gray-700 mb-4">×¤×¢×•×œ×•×ª</h3>
          <div className="flex flex-wrap gap-3">
            {selectedOrder.status === 'pending' && (
              <>
                <button onClick={() => updateStatus(selectedOrder.id, 'confirmed')} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700">âœ“ ××©×¨ ×”×–×× ×”</button>
                <button onClick={() => updateStatus(selectedOrder.id, 'cancelled')} className="bg-red-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-red-700">âœ• ×‘×˜×œ ×”×–×× ×”</button>
              </>
            )}
            {selectedOrder.status === 'confirmed' && (
              <button onClick={() => updateStatus(selectedOrder.id, 'ready')} className="bg-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-purple-700">ğŸ“¦ ×¡××Ÿ ×›××•×›×Ÿ</button>
            )}
            {selectedOrder.status === 'ready' && (
              <button onClick={() => updateStatus(selectedOrder.id, 'completed')} className="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700">âœ… ×¡××Ÿ ×›×”×•×©×œ×</button>
            )}
            <button onClick={() => window.print()} className="border border-gray-300 text-gray-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-50">ğŸ–¨ ×”×“×¤×¡</button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="fade-in">
      <h1 className="text-2xl font-bold text-gray-800 mb-6">ğŸ“‹ × ×™×”×•×œ ×”×–×× ×•×ª</h1>

      {/* Filters */}
      <div className="space-y-3 mb-4">
        <input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×©×, ×˜×œ×¤×•×Ÿ ××• ××¡×¤×¨ ×”×–×× ×”" className="px-4 py-2 rounded-lg border border-gray-200 bg-white w-full sm:w-64" />
        <div className="flex gap-2 flex-wrap">
          {['all', 'pending', 'confirmed', 'ready', 'completed', 'cancelled'].map(s => (
            <button key={s} onClick={() => setFilter(s)} className={`px-3 py-2 rounded-lg text-sm font-medium ${filter === s ? 'bg-green-600 text-white' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}`}>
              {s === 'all' ? '×”×›×œ' : STATUS_MAP[s].icon + ' ' + STATUS_MAP[s].label}
            </button>
          ))}
        </div>
      </div>

      {/* Orders table */}
      <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
        <table className="w-full text-sm min-w-max">
          <thead className="bg-gray-50">
            <tr>
              <th className="py-3 px-4 text-right font-medium text-gray-600">××¡×³</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×œ×§×•×—</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×˜×œ×¤×•×Ÿ</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×•×’</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¤×¨×™×˜×™×</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×›×•×</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¡×˜×˜×•×¡</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×–××Ÿ</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map(o => (
              <tr key={o.id} className="order-row border-b cursor-pointer" onClick={() => setSelectedOrder(o)}>
                <td className="py-3 px-4 font-bold">#{o.orderNumber}</td>
                <td className="py-3 px-4">{o.customerName}</td>
                <td className="py-3 px-4 text-gray-500" dir="ltr">{o.phone}</td>
                <td className="py-3 px-4">{o.deliveryType === 'delivery' ? 'ğŸš— ××©×œ×•×—' : 'ğŸ“ ××™×¡×•×£'}</td>
                <td className="py-3 px-4">{o.items.length} ×¤×¨×™×˜×™×</td>
                <td className="py-3 px-4 font-medium">{o.total.toFixed(2)}â‚ª</td>
                <td className="py-3 px-4">
                  <span className={`status-badge ${STATUS_MAP[o.status].color}`}>
                    {STATUS_MAP[o.status].icon} {STATUS_MAP[o.status].label}
                  </span>
                </td>
                <td className="py-3 px-4 text-gray-500 text-xs">{timeAgo(o.createdAt)}</td>
                <td className="py-3 px-4">
                  {o.status === 'pending' && (
                    <button onClick={(e) => { e.stopPropagation(); updateStatus(o.id, 'confirmed'); }} className="text-blue-600 hover:underline text-xs">××©×¨</button>
                  )}
                  {o.status === 'confirmed' && (
                    <button onClick={(e) => { e.stopPropagation(); updateStatus(o.id, 'ready'); }} className="text-purple-600 hover:underline text-xs">××•×›×Ÿ</button>
                  )}
                  {o.status === 'ready' && (
                    <button onClick={(e) => { e.stopPropagation(); updateStatus(o.id, 'completed'); }} className="text-green-600 hover:underline text-xs">×”×•×©×œ×</button>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        {filtered.length === 0 && (
          <div className="text-center py-12 text-gray-400">
            <p>××™×Ÿ ×”×–×× ×•×ª ××ª××™××•×ª</p>
          </div>
        )}
      </div>
    </div>
  );
}

// ==================== PRICING PAGE ====================
function PricingPage({ products, setProducts, dbConnected }) {
  const [editPrices, setEditPrices] = useState({});
  const [saved, setSaved] = useState(false);
  const [categoryFilter, setCategoryFilter] = useState('all');

  const initPrices = () => {
    const prices = {};
    products.forEach(p => { prices[p.id] = p.price; });
    setEditPrices(prices);
  };

  useEffect(() => { initPrices(); }, []);

  const handlePriceChange = (id, value) => {
    setEditPrices(prev => ({ ...prev, [id]: parseFloat(value) || 0 }));
  };

  const saveAllPrices = async () => {
    setProducts(prev => prev.map(p => ({ ...p, price: editPrices[p.id] || p.price })));

    // Save to Supabase
    if (sb && dbConnected) {
      const today = new Date().toISOString().split('T')[0];
      for (const p of products) {
        const newPrice = editPrices[p.id];
        if (newPrice && newPrice > 0) {
          await sb.from('daily_prices').upsert({
            product_id: p.id,
            date: today,
            price_nis: newPrice,
            stock_available: p.active !== false,
          }, { onConflict: 'product_id,date' });
        }
      }
    }

    setSaved(true);
    setTimeout(() => setSaved(false), 3000);
  };

  const filtered = categoryFilter === 'all' ? products : products.filter(p => p.category === categoryFilter);

  return (
    <div className="fade-in">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-3">
        <div>
          <h1 className="text-xl sm:text-2xl font-bold text-gray-800">ğŸ’° ×¢×“×›×•×Ÿ ××—×™×¨×™× ×™×•××™</h1>
          <p className="text-gray-500 text-sm">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: {new Date().toLocaleDateString('he-IL')} | {new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}</p>
        </div>
        <button
          onClick={saveAllPrices}
          className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition w-full sm:w-auto"
        >
          ğŸ’¾ ×©××•×¨ ××ª ×›×œ ×”××—×™×¨×™×
        </button>
      </div>

      {saved && (
        <div className="bg-green-100 border border-green-300 text-green-800 rounded-lg p-3 mb-4 font-medium">
          âœ… ×”××—×™×¨×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!
        </div>
      )}

      {/* Category filter */}
      <div className="flex gap-2 mb-4 flex-wrap">
        <button onClick={() => setCategoryFilter('all')} className={`px-3 py-2 rounded-lg text-sm font-medium ${categoryFilter === 'all' ? 'bg-green-600 text-white' : 'bg-white text-gray-600 border'}`}>×”×›×œ</button>
        {Object.entries(CATEGORY_MAP).map(([key, label]) => (
          <button key={key} onClick={() => setCategoryFilter(key)} className={`px-3 py-2 rounded-lg text-sm font-medium ${categoryFilter === key ? 'bg-green-600 text-white' : 'bg-white text-gray-600 border'}`}>{label}</button>
        ))}
      </div>

      <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
        <table className="w-full text-sm min-w-max">
          <thead className="bg-gray-50">
            <tr>
              <th className="py-3 px-4 text-right font-medium text-gray-600"></th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">××•×¦×¨</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×§×˜×’×•×¨×™×”</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×™×—×™×“×”</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">××—×™×¨ × ×•×›×—×™</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">××—×™×¨ ×—×“×© (â‚ª)</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×©×™× ×•×™</th>
              <th className="py-3 px-4 text-right font-medium text-gray-600">×¤×¢×™×œ</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map(p => {
              const newPrice = editPrices[p.id] || p.price;
              const change = ((newPrice - p.price) / p.price * 100);
              return (
                <tr key={p.id} className="border-b hover:bg-gray-50">
                  <td className="py-3 px-4">{getProductImage(p.name, p.imageUrl) ? <img src={getProductImage(p.name, p.imageUrl)} alt={p.name} className="w-10 h-10 rounded-lg object-cover" /> : <span className="text-xl">{p.image}</span>}</td>
                  <td className="py-3 px-4 font-medium">{p.name}</td>
                  <td className="py-3 px-4 text-gray-500">{CATEGORY_MAP[p.category]}</td>
                  <td className="py-3 px-4">{p.unit === 'kg' ? '×§"×’' : '×™×—×™×“×”'}</td>
                  <td className="py-3 px-4">{p.price.toFixed(2)}â‚ª</td>
                  <td className="py-3 px-4">
                    <input
                      type="number"
                      step="0.10"
                      min="0"
                      value={editPrices[p.id] || ''}
                      onChange={e => handlePriceChange(p.id, e.target.value)}
                      className="price-input px-3 py-2 rounded-lg border border-gray-200 text-center"
                      dir="ltr"
                    />
                  </td>
                  <td className="py-3 px-4">
                    {change !== 0 && (
                      <span className={`text-xs font-bold ${change > 0 ? 'text-red-600' : 'text-green-600'}`}>
                        {change > 0 ? 'â†‘' : 'â†“'} {Math.abs(change).toFixed(1)}%
                      </span>
                    )}
                  </td>
                  <td className="py-3 px-4">
                    <div
                      className={`toggle-switch ${p.active ? 'active' : ''}`}
                      onClick={() => setProducts(prev => prev.map(prod => prod.id === p.id ? { ...prod, active: !prod.active } : prod))}
                    ></div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* CSV Upload hint */}
      <div className="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4">
        <h3 className="font-bold text-blue-800 mb-2">ğŸ“„ ×”×¢×œ××ª ××—×™×¨×™× ××§×•×‘×¥ CSV</h3>
        <p className="text-sm text-blue-600">×‘×’×¨×¡×” ×”××œ××” - × ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×§×•×‘×¥ CSV ×¢× ××—×™×¨×™× ×™×•××™×™× ××”××—×™×¨×•×Ÿ ×”×¨×©××™ ×©×œ plants.moonsite.co.il</p>
        <p className="text-xs text-blue-500 mt-1">×¤×•×¨××˜: ×©×_××•×¦×¨, ××—×™×¨, ×–××™×Ÿ (×›×Ÿ/×œ×)</p>
      </div>
    </div>
  );
}

// ==================== PRODUCTS PAGE ====================
function ProductsPage({ products, setProducts, dbConnected }) {
  const [showForm, setShowForm] = useState(false);
  const [editProduct, setEditProduct] = useState(null);
  const [form, setForm] = useState({ name: '', category: 'fruits', unit: 'kg', price: '', image: 'ğŸ', active: true });

  const startEdit = (product) => {
    setEditProduct(product);
    setForm({ name: product.name, category: product.category, unit: product.unit, price: product.price, image: product.image, active: product.active });
    setShowForm(true);
  };

  const startNew = () => {
    setEditProduct(null);
    setForm({ name: '', category: 'fruits', unit: 'kg', price: '', image: 'ğŸ', active: true });
    setShowForm(true);
  };

  const saveProduct = async () => {
    if (!form.name || !form.price) return;
    if (editProduct) {
      setProducts(prev => prev.map(p => p.id === editProduct.id ? { ...p, ...form, price: parseFloat(form.price) } : p));
      if (sb && dbConnected) {
        await sb.from('products').update({
          name_he: form.name, category: form.category, unit: form.unit,
          image_emoji: form.image, is_active: form.active
        }).eq('id', editProduct.id);
      }
    } else {
      if (sb && dbConnected) {
        const { data, error } = await sb.from('products').insert({
          name_he: form.name, category: form.category, unit: form.unit,
          image_emoji: form.image, is_active: form.active
        }).select().single();
        if (data) {
          setProducts(prev => [...prev, { id: data.id, name: form.name, category: form.category, unit: form.unit, price: parseFloat(form.price), active: form.active, image: form.image }]);
        }
      } else {
        const newId = Math.max(0, ...products.map(p => typeof p.id === 'number' ? p.id : 0)) + 1;
        setProducts(prev => [...prev, { id: newId, ...form, price: parseFloat(form.price) }]);
      }
    }
    setShowForm(false);
  };

  const deleteProduct = async (id) => {
    if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××•×¦×¨ ×–×”?')) {
      setProducts(prev => prev.filter(p => p.id !== id));
      if (sb && dbConnected) {
        await sb.from('products').delete().eq('id', id);
      }
    }
  };

  const toggleActive = async (product) => {
    setProducts(prev => prev.map(p => p.id === product.id ? { ...p, active: !p.active } : p));
    if (sb && dbConnected) {
      await sb.from('products').update({ is_active: !product.active }).eq('id', product.id);
    }
  };

  const emojis = ['ğŸ','ğŸŒ','ğŸ‡','ğŸ‰','ğŸ','ğŸ‘','ğŸ“','ğŸŠ','ğŸ‹','ğŸ¥­','ğŸ¥‘','ğŸ','ğŸ¥','ğŸ’','ğŸ…','ğŸ¥’','ğŸ«‘','ğŸ¥¬','ğŸ¥•','ğŸ§…','ğŸ¥”','ğŸ†','ğŸ ','ğŸ¥¦','ğŸŒ¿','ğŸ§„'];

  return (
    <div className="fade-in">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-3">
        <h1 className="text-xl sm:text-2xl font-bold text-gray-800">ğŸ“¦ × ×™×”×•×œ ××•×¦×¨×™×</h1>
        <button onClick={startNew} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 w-full sm:w-auto">+ ×”×•×¡×£ ××•×¦×¨</button>
      </div>

      {/* Product form modal */}
      {showForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 w-full max-w-md">
            <h2 className="text-xl font-bold mb-4">{editProduct ? '×¢×¨×•×š ××•×¦×¨' : '××•×¦×¨ ×—×“×©'}</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">×©× ×”××•×¦×¨ *</label>
                <input type="text" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className="w-full px-4 py-2 rounded-lg border border-gray-200" />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">×§×˜×’×•×¨×™×”</label>
                  <select value={form.category} onChange={e => setForm({ ...form, category: e.target.value })} className="w-full px-4 py-2 rounded-lg border border-gray-200">
                    {Object.entries(CATEGORY_MAP).map(([key, label]) => (
                      <option key={key} value={key}>{label}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">×™×—×™×“×ª ××“×™×“×”</label>
                  <select value={form.unit} onChange={e => setForm({ ...form, unit: e.target.value })} className="w-full px-4 py-2 rounded-lg border border-gray-200">
                    <option value="kg">×§"×’</option>
                    <option value="unit">×™×—×™×“×”</option>
                  </select>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">××—×™×¨ (â‚ª) *</label>
                <input type="number" step="0.10" value={form.price} onChange={e => setForm({ ...form, price: e.target.value })} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">××™×™×§×•×Ÿ</label>
                <div className="flex flex-wrap gap-2">
                  {emojis.map(e => (
                    <button key={e} onClick={() => setForm({ ...form, image: e })} className={`text-2xl p-1 rounded ${form.image === e ? 'bg-green-100 ring-2 ring-green-500' : ''}`}>{e}</button>
                  ))}
                </div>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={() => setShowForm(false)} className="flex-1 border border-gray-300 py-2 rounded-lg font-medium">×‘×™×˜×•×œ</button>
              <button onClick={saveProduct} className="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">×©××•×¨</button>
            </div>
          </div>
        </div>
      )}

      {/* Products grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {products.map(p => (
          <div key={p.id} className={`bg-white rounded-xl p-4 shadow-sm border ${!p.active ? 'opacity-50' : ''}`}>
            <div className="flex items-center gap-3 mb-3">
              {getProductImage(p.name, p.imageUrl) ? (
                <img src={getProductImage(p.name, p.imageUrl)} alt={p.name} className="w-14 h-14 rounded-lg object-cover" />
              ) : (
                <span className="text-3xl">{p.image}</span>
              )}
              <div className="flex-1">
                <h3 className="font-bold">{p.name}</h3>
                <p className="text-xs text-gray-500">{CATEGORY_MAP[p.category]} | {p.unit === 'kg' ? '×§"×’' : '×™×—×™×“×”'}</p>
              </div>
              <span className="text-lg font-bold text-green-700">{p.price.toFixed(2)}â‚ª</span>
            </div>
            <div className="flex gap-2">
              <button onClick={() => startEdit(p)} className="flex-1 text-xs border border-blue-300 text-blue-600 py-1 rounded hover:bg-blue-50">âœï¸ ×¢×¨×•×š</button>
              <button onClick={() => toggleActive(p)} className={`flex-1 text-xs border py-1 rounded ${p.active ? 'border-gray-300 text-gray-600 hover:bg-gray-50' : 'border-green-300 text-green-600 hover:bg-green-50'}`}>
                {p.active ? 'ğŸš« ×”×©×‘×ª' : 'âœ… ×”×¤×¢×œ'}
              </button>
              <button onClick={() => deleteProduct(p.id)} className="text-xs border border-red-300 text-red-600 py-1 px-2 rounded hover:bg-red-50">ğŸ—‘</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ==================== SETTINGS PAGE ====================
function SettingsPage({ settings, setSettings, dbConnected }) {
  const [saved, setSaved] = useState(false);
  const [saving, setSaving] = useState(false);
  const [saveError, setSaveError] = useState('');

  const handleChange = (key, value) => {
    setSettings(prev => ({ ...prev, [key]: value }));
  };

  const save = async () => {
    setSaving(true);
    setSaveError('');
    try {
      if (sb && dbConnected) {
        const settingsMap = {
          'store_name': settings.name,
          'ordering_open': String(settings.orderingOpen),
          'ordering_start_hour': settings.orderingStartHour,
          'ordering_end_hour': settings.orderingEndHour,
          'delivery_fee': String(settings.deliveryFee),
          'min_order_amount': String(settings.minOrderAmount),
          'delivery_enabled': String(settings.deliveryEnabled),
          'pickup_enabled': String(settings.pickupEnabled),
          'store_address': settings.address,
          'store_phone': settings.phone,
          'delivery_area': settings.deliveryArea,
          'emailjs_enabled': String(settings.emailjsEnabled),
          'emailjs_service_id': settings.emailjsServiceId,
          'emailjs_template_id': settings.emailjsTemplateId,
          'emailjs_public_key': settings.emailjsPublicKey,
          'emailjs_to_email': settings.emailjsToEmail,
          'whatsapp_enabled': String(settings.whatsappEnabled),
          'whatsapp_phone': settings.whatsappPhone,
          'whatsapp_api_key': settings.whatsappApiKey,
        };
        for (const [key, value] of Object.entries(settingsMap)) {
          await sb
            .from('store_settings')
            .upsert({ setting_key: key, setting_value: value || '' }, { onConflict: 'setting_key' });
        }
      }
      setSaved(true);
      setTimeout(() => setSaved(false), 3000);
    } catch (err) {
      console.error('Error saving settings:', err);
      setSaveError('×©×’×™××” ×‘×©××™×¨×ª ×”×”×’×“×¨×•×ª: ' + err.message);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="fade-in">
      <h1 className="text-2xl font-bold text-gray-800 mb-6">âš™ï¸ ×”×’×“×¨×•×ª ×—× ×•×ª</h1>

      {saved && (
        <div className="bg-green-100 border border-green-300 text-green-800 rounded-lg p-3 mb-4 font-medium">
          âœ… ×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!
        </div>
      )}

      <div className="space-y-6">
        {/* Ordering window */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ• ×—×œ×•×Ÿ ×”×–×× ×•×ª</h2>

          <div className="flex items-center justify-between mb-6 bg-gray-50 rounded-lg p-4">
            <div>
              <h3 className="font-bold text-lg">{settings.orderingOpen ? 'âœ… ×”×–×× ×•×ª ×¤×ª×•×—×•×ª' : 'âŒ ×”×–×× ×•×ª ×¡×’×•×¨×•×ª'}</h3>
              <p className="text-sm text-gray-500">×œ×—×¥ ×›×“×™ {settings.orderingOpen ? '×œ×¡×’×•×¨' : '×œ×¤×ª×•×—'} ××ª ×”×”×–×× ×•×ª</p>
            </div>
            <div
              className={`toggle-switch ${settings.orderingOpen ? 'active' : ''}`}
              onClick={() => handleChange('orderingOpen', !settings.orderingOpen)}
            ></div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×©×¢×ª ×¤×ª×™×—×”</label>
              <input type="time" value={settings.orderingStartHour} onChange={e => handleChange('orderingStartHour', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×©×¢×ª ×¡×’×™×¨×”</label>
              <input type="time" value={settings.orderingEndHour} onChange={e => handleChange('orderingEndHour', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
          </div>
        </div>

        {/* Delivery */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸš— ×”×’×“×¨×•×ª ××©×œ×•×—</h2>

          <div className="flex items-center justify-between mb-4">
            <span className="font-medium">××¤×©×¨ ××©×œ×•×—×™×</span>
            <div className={`toggle-switch ${settings.deliveryEnabled ? 'active' : ''}`} onClick={() => handleChange('deliveryEnabled', !settings.deliveryEnabled)}></div>
          </div>

          <div className="flex items-center justify-between mb-4">
            <span className="font-medium">××¤×©×¨ ××™×¡×•×£ ×¢×¦××™</span>
            <div className={`toggle-switch ${settings.pickupEnabled ? 'active' : ''}`} onClick={() => handleChange('pickupEnabled', !settings.pickupEnabled)}></div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×¢××œ×ª ××©×œ×•×— (â‚ª)</label>
              <input type="number" value={settings.deliveryFee} onChange={e => handleChange('deliveryFee', parseFloat(e.target.value) || 0)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×”×–×× ×” ××™× ×™××œ×™×ª (â‚ª)</label>
              <input type="number" value={settings.minOrderAmount} onChange={e => handleChange('minOrderAmount', parseFloat(e.target.value) || 0)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
          </div>

          <div className="mt-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">××–×•×¨ ××©×œ×•×—</label>
            <input type="text" value={settings.deliveryArea} onChange={e => handleChange('deliveryArea', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" />
          </div>
        </div>

        {/* Store info */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ“ ×¤×¨×˜×™ ×”×—× ×•×ª</h2>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×©× ×”×—× ×•×ª</label>
              <input type="text" value={settings.name} onChange={e => handleChange('name', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×›×ª×•×‘×ª</label>
              <input type="text" value={settings.address} onChange={e => handleChange('address', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">×˜×œ×¤×•×Ÿ</label>
              <input type="text" value={settings.phone} onChange={e => handleChange('phone', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200" dir="ltr" />
            </div>
          </div>
        </div>

        {/* Email Notifications */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ“§ ×”×ª×¨××•×ª ××™××™×™×œ (EmailJS)</h2>

          <div className="flex items-center justify-between mb-4 bg-gray-50 rounded-lg p-4">
            <div>
              <h3 className="font-bold">{settings.emailjsEnabled ? 'âœ… ×”×ª×¨××•×ª ××™××™×™×œ ×¤×¢×™×œ×•×ª' : 'âŒ ×”×ª×¨××•×ª ××™××™×™×œ ×›×‘×•×™×•×ª'}</h3>
              <p className="text-sm text-gray-500">×©×œ×— ××™××™×™×œ ×›×©××ª×§×‘×œ×ª ×”×–×× ×” ×—×“×©×”</p>
            </div>
            <div
              className={`toggle-switch ${settings.emailjsEnabled ? 'active' : ''}`}
              onClick={() => handleChange('emailjsEnabled', !settings.emailjsEnabled)}
            ></div>
          </div>

          {settings.emailjsEnabled && (
            <div className="space-y-3">
              <p className="text-xs text-gray-500 bg-blue-50 border border-blue-200 rounded-lg p-3">
                ğŸ“Œ ×”×™×¨×©× ×‘×—×™× × ×‘-<a href="https://www.emailjs.com" target="_blank" className="text-blue-600 underline" dir="ltr">emailjs.com</a> â† ×¦×•×¨ ×©×™×¨×•×ª (Gmail) + ×ª×‘× ×™×ª ×¢× ×”××©×ª× ×™×: {'{'}order_number{'}'}, {'{'}customer_name{'}'}, {'{'}customer_phone{'}'}, {'{'}delivery_type{'}'}, {'{'}address{'}'}, {'{'}items{'}'}, {'{'}total{'}'}, {'{'}notes{'}'}
              </p>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Service ID</label>
                  <input type="text" value={settings.emailjsServiceId} onChange={e => handleChange('emailjsServiceId', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="service_xxxxxxx" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Template ID</label>
                  <input type="text" value={settings.emailjsTemplateId} onChange={e => handleChange('emailjsTemplateId', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="template_xxxxxxx" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Public Key</label>
                  <input type="text" value={settings.emailjsPublicKey} onChange={e => handleChange('emailjsPublicKey', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="xxxxxxxxxxxx" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">××™××™×™×œ ×œ×§×‘×œ×ª ×”×ª×¨××•×ª</label>
                  <input type="email" value={settings.emailjsToEmail} onChange={e => handleChange('emailjsToEmail', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="admin@example.com" />
                </div>
              </div>
            </div>
          )}
        </div>

        {/* WhatsApp Notifications */}
        <div className="bg-white rounded-xl shadow-sm p-6">
          <h2 className="font-bold text-lg text-gray-800 mb-4">ğŸ’¬ ×”×ª×¨××•×ª ×•×•××˜×¡××¤ (CallMeBot)</h2>

          <div className="flex items-center justify-between mb-4 bg-gray-50 rounded-lg p-4">
            <div>
              <h3 className="font-bold">{settings.whatsappEnabled ? 'âœ… ×”×ª×¨××•×ª ×•×•××˜×¡××¤ ×¤×¢×™×œ×•×ª' : 'âŒ ×”×ª×¨××•×ª ×•×•××˜×¡××¤ ×›×‘×•×™×•×ª'}</h3>
              <p className="text-sm text-gray-500">×©×œ×— ×”×•×“×¢×ª ×•×•××˜×¡××¤ ×›×©××ª×§×‘×œ×ª ×”×–×× ×” ×—×“×©×”</p>
            </div>
            <div
              className={`toggle-switch ${settings.whatsappEnabled ? 'active' : ''}`}
              onClick={() => handleChange('whatsappEnabled', !settings.whatsappEnabled)}
            ></div>
          </div>

          {settings.whatsappEnabled && (
            <div className="space-y-3">
              <p className="text-xs text-gray-500 bg-green-50 border border-green-200 rounded-lg p-3">
                ğŸ“Œ ×©×œ×— ×”×•×“×¢×” ×œ-<strong dir="ltr">+34 644 59 71 67</strong> ×‘×•×•××˜×¡××¤ ×¢× ×”×˜×§×¡×˜: <strong dir="ltr">I allow callmebot to send me messages</strong> â† ×ª×§×‘×œ API Key ×‘×ª×’×•×‘×”
              </p>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">××¡×¤×¨ ×˜×œ×¤×•×Ÿ (×¢× ×§×™×“×•××ª ××“×™× ×”)</label>
                  <input type="text" value={settings.whatsappPhone} onChange={e => handleChange('whatsappPhone', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="972501234567" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                  <input type="text" value={settings.whatsappApiKey} onChange={e => handleChange('whatsappApiKey', e.target.value)} className="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm" dir="ltr" placeholder="123456" />
                </div>
              </div>
            </div>
          )}
        </div>

        {saveError && (
          <div className="bg-red-100 border border-red-300 text-red-800 rounded-lg p-3 mb-4 font-medium">
            âŒ {saveError}
          </div>
        )}

        <button onClick={save} disabled={saving} className={`${saving ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700'} text-white px-8 py-3 rounded-lg font-bold transition w-full md:w-auto`}>
          {saving ? 'â³ ×©×•××¨...' : 'ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª'}
        </button>

        {!dbConnected && (
          <p className="text-sm text-yellow-600 mt-2">âš ï¸ ×œ× ××—×•×‘×¨ ×œ-Supabase - ×”×©×™× ×•×™×™× × ×©××¨×™× ×¨×§ ××§×•××™×ª</p>
        )}
      </div>
    </div>
  );
}

// ==================== NOTIFICATION SOUND ====================
function playNotificationSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.15);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.3);
      osc.start(ctx.currentTime + i * 0.15);
      osc.stop(ctx.currentTime + i * 0.15 + 0.3);
    });
  } catch (e) { console.log('Audio not supported'); }
}

// ==================== EMAIL & WHATSAPP NOTIFICATIONS ====================
async function sendEmailNotification(order, settings) {
  if (!settings.emailjsEnabled || !settings.emailjsServiceId || !settings.emailjsTemplateId || !settings.emailjsPublicKey) return;
  try {
    const itemsList = order.items.map(i => `${i.name} x${i.qty} ${i.unit === 'kg' ? '×§"×’' : '×™×—×³'}`).join(', ');
    await emailjs.send(settings.emailjsServiceId, settings.emailjsTemplateId, {
      to_email: settings.emailjsToEmail,
      order_number: order.orderNumber,
      customer_name: order.customerName,
      customer_phone: order.phone,
      delivery_type: order.deliveryType === 'delivery' ? '××©×œ×•×—' : '××™×¡×•×£ ×¢×¦××™',
      address: order.address || '-',
      items: itemsList,
      total: order.total.toFixed(2),
      notes: order.notes || '-',
    }, settings.emailjsPublicKey);
    console.log('Email notification sent');
  } catch (err) {
    console.error('Email notification failed:', err);
  }
}

async function sendWhatsAppNotification(order, settings) {
  if (!settings.whatsappEnabled || !settings.whatsappPhone || !settings.whatsappApiKey) return;
  try {
    const itemsList = order.items.map(i => `â€¢ ${i.name} x${i.qty}`).join('%0A');
    const message = encodeURIComponent(
      `ğŸ›’ ×”×–×× ×” ×—×“×©×” #${order.orderNumber}\n` +
      `ğŸ‘¤ ${order.customerName}\n` +
      `ğŸ“± ${order.phone}\n` +
      `${order.deliveryType === 'delivery' ? 'ğŸš— ××©×œ×•×—: ' + order.address : 'ğŸ“ ××™×¡×•×£ ×¢×¦××™'}\n` +
      `ğŸ’° ×¡×”"×›: ${order.total.toFixed(2)}â‚ª\n` +
      (order.notes ? `ğŸ“ ${order.notes}\n` : '')
    );
    const phone = settings.whatsappPhone.replace(/[^0-9]/g, '');
    const url = `https://api.callmebot.com/whatsapp.php?phone=${phone}&text=${message}&apikey=${settings.whatsappApiKey}`;
    await fetch(url, { mode: 'no-cors' });
    console.log('WhatsApp notification sent');
  } catch (err) {
    console.error('WhatsApp notification failed:', err);
  }
}

// ==================== MAIN APP ====================
function AdminApp() {
  const [loggedIn, setLoggedIn] = useState(false);
  const [user, setUser] = useState(null);
  const [page, setPage] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [orders, setOrders] = useState(INITIAL_ORDERS);
  const [products, setProducts] = useState(INITIAL_PRODUCTS);
  const [dbConnected, setDbConnected] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const knownOrderIdsRef = React.useRef(null);
  const settingsRef = React.useRef(null);
  const [settings, setSettings] = useState({
    orderingOpen: true,
    orderingStartHour: '07:00',
    orderingEndHour: '20:00',
    deliveryFee: 15,
    minOrderAmount: 50,
    deliveryEnabled: true,
    pickupEnabled: true,
    name: '×‘×¨×›×ª ×”×©×“×”',
    address: '×¨×—×•×‘ ×”×¨×¦×œ 12, ×‘×™×ª ×©××©',
    phone: '02-999-8888',
    deliveryArea: '×‘×™×ª ×©××© ×‘×œ×‘×“',
    // Notification settings
    emailjsEnabled: false,
    emailjsServiceId: '',
    emailjsTemplateId: '',
    emailjsPublicKey: '',
    emailjsToEmail: 'shaked4561@gmail.com',
    whatsappEnabled: false,
    whatsappPhone: '972542556706',
    whatsappApiKey: '',
  });

  // Keep settings ref in sync for use inside loadFromDB closure
  useEffect(() => { settingsRef.current = settings; }, [settings]);

  // Load data from Supabase
  async function loadFromDB() {
    if (!sb) return;
    try {
      // Load orders with items
      const { data: dbOrders, error: ordErr } = await sb
        .from('orders')
        .select('*')
        .order('created_at', { ascending: false });
      if (ordErr) throw ordErr;

      // Load order items for each order
      const orderIds = dbOrders.map(o => o.id);
      const { data: dbItems } = await sb
        .from('order_items')
        .select('*')
        .in('order_id', orderIds);

      const itemsByOrder = {};
      if (dbItems) dbItems.forEach(i => {
        if (!itemsByOrder[i.order_id]) itemsByOrder[i.order_id] = [];
        itemsByOrder[i.order_id].push({ name: i.product_name_he, qty: parseFloat(i.quantity), unit: i.unit_type, price: parseFloat(i.price_at_purchase) });
      });

      const mappedOrders = dbOrders.map(o => ({
        id: o.id,
        orderNumber: o.order_number,
        customerName: o.customer_name,
        phone: o.customer_phone,
        email: o.customer_email || '',
        deliveryType: o.delivery_type,
        address: o.delivery_address || '',
        items: itemsByOrder[o.id] || [],
        total: parseFloat(o.total_amount),
        status: o.status,
        paymentStatus: o.payment_status,
        notes: o.notes || '',
        createdAt: new Date(o.created_at),
      }));

      // Detect new orders
      if (knownOrderIdsRef.current !== null) {
        const newOrders = mappedOrders.filter(o => !knownOrderIdsRef.current.has(o.id));
        if (newOrders.length > 0) {
          playNotificationSound();
          const currentSettings = settingsRef.current;
          newOrders.forEach(o => {
            const notif = { id: Date.now() + '-' + o.id, orderNumber: o.orderNumber, customerName: o.customerName, total: o.total };
            setNotifications(prev => [...prev, notif]);
            setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== notif.id)), 6000);
            // Browser notification
            if (Notification.permission === 'granted') {
              new Notification('×”×–×× ×” ×—×“×©×”!', { body: `#${o.orderNumber} - ${o.customerName} | ${o.total.toFixed(2)}â‚ª`, icon: 'ğŸ›’' });
            }
            // Email & WhatsApp notifications
            sendEmailNotification(o, currentSettings);
            sendWhatsAppNotification(o, currentSettings);
          });
        }
      }
      knownOrderIdsRef.current = new Set(mappedOrders.map(o => o.id));

      setOrders(mappedOrders);

      // Load products
      const { data: dbProds } = await sb.from('products').select('*').order('sort_order');
      if (dbProds) {
        const mappedProds = dbProds.map(p => ({
          id: p.id, name: p.name_he, category: p.category, unit: p.unit,
          price: 0, active: p.is_active, image: p.image_emoji || 'ğŸ', imageUrl: p.image_url || null,
        }));

        // Load today prices
        const today = new Date().toISOString().split('T')[0];
        const { data: prices } = await sb.from('daily_prices').select('*').eq('date', today);
        if (prices) {
          const priceMap = {};
          prices.forEach(p => { priceMap[p.product_id] = parseFloat(p.price_nis); });
          mappedProds.forEach(p => { if (priceMap[p.id]) p.price = priceMap[p.id]; });
        }
        setProducts(mappedProds);
      }

      // Load settings
      const { data: dbSets } = await sb.from('store_settings').select('*');
      if (dbSets && dbSets.length > 0) {
        const sObj = {};
        dbSets.forEach(s => { sObj[s.setting_key] = s.setting_value; });
        setSettings(prev => ({
          ...prev,
          orderingOpen: sObj.ordering_open === 'true',
          orderingStartHour: sObj.ordering_start_hour || '07:00',
          orderingEndHour: sObj.ordering_end_hour || '20:00',
          deliveryFee: parseFloat(sObj.delivery_fee) || 15,
          minOrderAmount: parseFloat(sObj.min_order_amount) || 50,
          deliveryEnabled: sObj.delivery_enabled === 'true',
          pickupEnabled: sObj.pickup_enabled === 'true',
          name: sObj.store_name || '×‘×¨×›×ª ×”×©×“×”',
          address: sObj.store_address || '',
          phone: sObj.store_phone || '',
          deliveryArea: sObj.delivery_area || '',
          // Notification settings from DB
          emailjsEnabled: sObj.emailjs_enabled === 'true' || prev.emailjsEnabled,
          emailjsServiceId: sObj.emailjs_service_id || prev.emailjsServiceId,
          emailjsTemplateId: sObj.emailjs_template_id || prev.emailjsTemplateId,
          emailjsPublicKey: sObj.emailjs_public_key || prev.emailjsPublicKey,
          emailjsToEmail: sObj.emailjs_to_email || prev.emailjsToEmail,
          whatsappEnabled: sObj.whatsapp_enabled === 'true' || prev.whatsappEnabled,
          whatsappPhone: sObj.whatsapp_phone || prev.whatsappPhone,
          whatsappApiKey: sObj.whatsapp_api_key || prev.whatsappApiKey,
        }));
      }
      setDbConnected(true);
    } catch (err) {
      console.log('DB not ready, using mock data:', err.message);
    }
  }

  useEffect(() => { if (loggedIn) loadFromDB(); }, [loggedIn]);

  // Auto-refresh orders every 15 seconds
  useEffect(() => {
    if (!loggedIn || !dbConnected) return;
    const interval = setInterval(loadFromDB, 15000);
    return () => clearInterval(interval);
  }, [loggedIn, dbConnected]);

  const handleLogin = (userData) => {
    setUser(userData);
    setLoggedIn(true);
    // Request browser notification permission
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  };

  // Update order status in Supabase
  const setOrdersWithDB = async (updater) => {
    setOrders(updater);
    // The OrdersPage calls setOrders with a function - we intercept and also update DB
  };

  // Wrapper to update order status in DB
  const updateOrderStatusDB = async (orderId, newStatus) => {
    setOrders(prev => prev.map(o => o.id === orderId ? { ...o, status: newStatus } : o));
    if (sb && dbConnected) {
      await sb.from('orders').update({ status: newStatus }).eq('id', orderId);
    }
  };

  if (!loggedIn) return <LoginPage onLogin={handleLogin} />;

  const PAGE_TITLES = { dashboard: '×“×©×‘×•×¨×“', orders: '×”×–×× ×•×ª', pricing: '××—×™×¨×™×', products: '××•×¦×¨×™×', settings: '×”×’×“×¨×•×ª' };

  return (
    <div className="flex">
      {/* New order notifications */}
      {notifications.map(n => (
        <div key={n.id} className="notification-toast bg-green-600 text-white rounded-xl shadow-lg px-6 py-4 flex items-center gap-3" onClick={() => { setPage('orders'); setNotifications(prev => prev.filter(x => x.id !== n.id)); }}>
          <span className="text-2xl">ğŸ›’</span>
          <div>
            <div className="font-bold">×”×–×× ×” ×—×“×©×”!</div>
            <div className="text-sm">#{n.orderNumber} - {n.customerName} | {n.total.toFixed(2)}â‚ª</div>
          </div>
          <button onClick={(e) => { e.stopPropagation(); setNotifications(prev => prev.filter(x => x.id !== n.id)); }} className="mr-2 text-white text-xl leading-none hover:opacity-70">&times;</button>
        </div>
      ))}

      {/* Mobile top bar */}
      <div className="mobile-topbar">
        <button onClick={() => setSidebarOpen(true)} className="text-2xl leading-none p-1">â˜°</button>
        <span className="font-bold text-lg">{PAGE_TITLES[page]}</span>
      </div>

      <Sidebar activePage={page} setPage={setPage} user={user} onLogout={() => setLoggedIn(false)} isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} />
      <main className="main-content flex-1 p-4 sm:p-6 min-h-screen" style={{ marginRight: '256px' }}>
        {!dbConnected && (
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-yellow-800 text-sm">
            âš ï¸ ×œ× ××—×•×‘×¨ ×œ-Supabase - ××¦×™×’ × ×ª×•× ×™ ×“××•. ×”×¨×¥ ××ª ×§×‘×¦×™ ×”-SQL ×›×“×™ ×œ×—×‘×¨ ×œ×‘×¡×™×¡ ×”× ×ª×•× ×™×.
          </div>
        )}
        {dbConnected && (
          <div className="bg-green-50 border border-green-200 rounded-lg p-2 mb-4 text-green-800 text-xs flex items-center justify-between">
            <span>âœ… ××—×•×‘×¨ ×œ-Supabase | ××ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ×›×œ 15 ×©× ×™×•×ª</span>
            <button onClick={loadFromDB} className="text-green-700 font-bold hover:underline">ğŸ”„ ×¨×¢× ×Ÿ ×¢×›×©×™×•</button>
          </div>
        )}
        {page === 'dashboard' && <DashboardPage orders={orders} settings={settings} />}
        {page === 'orders' && <OrdersPage orders={orders} setOrders={setOrders} updateStatusDB={updateOrderStatusDB} dbConnected={dbConnected} />}
        {page === 'pricing' && <PricingPage products={products} setProducts={setProducts} dbConnected={dbConnected} />}
        {page === 'products' && <ProductsPage products={products} setProducts={setProducts} dbConnected={dbConnected} />}
        {page === 'settings' && <SettingsPage settings={settings} setSettings={setSettings} dbConnected={dbConnected} />}
      </main>
    </div>
  );
}

ReactDOM.render(<AdminApp />, document.getElementById('root'));
</script>
</body>
</html>
